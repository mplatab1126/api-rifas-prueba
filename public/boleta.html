<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Boleta Virtual - Apartamento</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Playfair+Display:ital,wght@0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
      /* --- ESTILOS VISUALES (Se mantienen igual de hermosos) --- */
      :root { --gold: #C5A059; --dark: #1a1a1a; --soft-wood: #F9F6F2; --white: #ffffff; }
      body { margin: 0; padding: 0; background: #e0e0e0; font-family: 'Montserrat', sans-serif; color: var(--dark); -webkit-tap-highlight-color: transparent; }
      .page-wrapper { max-width: 480px; margin: 0 auto; background: var(--white); overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.05); position: relative; }
      .hero-section { position: relative; text-align: center; background: var(--dark); color: white; padding-bottom: 3rem; }
      .brand-logo { display: block; margin: 10px auto 0; width: 100px; height: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); position: relative; z-index: 10; }
      .hero-bg-img { width: 100%; height: 380px; object-fit: cover; opacity: 0.7; mask-image: linear-gradient(to bottom, black 60%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%); }
      .floating-info { margin-top: -140px; position: relative; z-index: 2; padding: 0 20px; }
      .ticket-number { font-family: 'Playfair Display', serif; font-size: 5rem; color: var(--gold); line-height: 0.9; margin: 10px 0; text-shadow: 2px 2px 8px rgba(0,0,0,0.8); font-weight: 700; }
      .badge { display: inline-block; background: var(--gold); color: var(--dark); padding: 6px 18px; border-radius: 50px; font-size: 0.75rem; letter-spacing: 2px; font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.4); }
      .client-box { padding: 1.5rem; background: var(--soft-wood); margin: -20px 20px 30px; border-radius: 15px; position: relative; z-index: 5; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border-bottom: 3px solid var(--gold); }
      .client-box h3 { font-family: 'Playfair Display', serif; margin-top: 0; color: var(--dark); font-size: 1.2rem; text-align: center; margin-bottom: 1.5rem; }
      .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9rem; }
      .data-item span { display: block; font-size: 0.75rem; color: #888; margin-bottom: 3px; }
      .data-item strong { display: block; font-size: 1rem; }
      .financial-row { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc; }
      /* (Omit√≠ visuales extra como roadmap para que el c√≥digo no sea inmenso, pero puedes pegar los tuyos si prefieres. Dej√© lo esencial de la boleta) */
      .policies-area { padding: 30px 20px 80px; font-size: 0.75rem; background: #1a1a1a; color: #aaa; text-align: center; line-height: 1.6; }
      .btn-container { padding: 15px 20px; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.98); z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); display: flex; justify-content: center; }
      .download-btn { width: 100%; max-width: 440px; padding: 1.1rem; background: var(--dark); color: var(--gold); border: none; border-radius: 50px; font-weight: 700; cursor: pointer; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 5px 15px rgba(197, 160, 89, 0.3); transition: transform 0.2s; }

      /* --- FILTRO DE SEGURIDAD --- */
      #security-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f4f4; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; }
      .security-box { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 350px; width: 100%; border-top: 5px solid var(--gold); }
      .security-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
      .security-title { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: var(--dark); margin-bottom: 10px; }
      .security-desc { font-size: 0.9rem; color: #666; margin-bottom: 20px; }
      .security-input { width: 100%; padding: 12px; font-size: 1.1rem; border: 2px solid #eee; border-radius: 8px; text-align: center; margin-bottom: 15px; outline: none; transition: 0.3s; box-sizing: border-box; }
      .security-input:focus { border-color: var(--gold); }
      .security-btn { background: var(--dark); color: var(--gold); border: none; padding: 12px 25px; font-size: 1rem; border-radius: 50px; cursor: pointer; font-weight: bold; width: 100%; text-transform: uppercase; }
      .error-msg { color: #d32f2f; font-size: 0.8rem; margin-top: 10px; display: none; font-weight: bold; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  </head>
  <body>

  <div id="security-overlay">
    <div class="security-box">
      <span class="security-icon">üîí</span>
      <h2 class="security-title">Zona Segura</h2>
      <p class="security-desc">Por seguridad, confirma el n√∫mero de celular registrado para ver la boleta <strong id="lbl-boleta">---</strong>.</p>
      <input type="tel" id="inputPhone" class="security-input" placeholder="Ingresa tu celular aqu√≠" inputmode="numeric">
      <button class="security-btn" id="btnVerificar" onclick="verificarIdentidad()">VER MI BOLETA</button>
      <p id="errorMsg" class="error-msg">‚ùå El n√∫mero no coincide. Intenta de nuevo.</p>
    </div>
  </div>

  <div class="page-wrapper" id="captureArea">
    <section class="hero-section">
      <img src="https://losplata.s3.us-east-2.amazonaws.com/sala+h.png" class="hero-bg-img" crossOrigin="anonymous">
      <div class="floating-info">
        <span class="badge">BOLETA OFICIAL DIGITAL</span>
        <div class="ticket-number" id="val-numero">0000</div>
        <p style="font-family: 'Playfair Display', serif; font-style: italic; margin-top: 5px; opacity: 0.9;">Tu llave al apartamento so√±ado</p>
        <img src="https://losplata.s3.us-east-2.amazonaws.com/Logo.png" class="brand-logo" crossOrigin="anonymous" alt="Logo">
      </div>
    </section>

    <section class="client-box">
      <h3>TITULAR DE LA BOLETA</h3>
      <div class="data-grid">
        <div class="data-item"><span>Titular:</span> <strong><span id="val-nombre">Cargando...</span> <span id="val-apellido"></span></strong></div>
        <div class="data-item"><span>Ciudad:</span> <strong><span id="val-ciudad">---</span></strong></div>
        <div class="data-item"><span>Tel√©fono:</span> <strong><span id="val-telefono">---</span></strong></div>
        <div class="data-item"><span>Sorteo:</span> <strong>Loter√≠a de Boyac√°</strong></div>
      </div>
      <div class="financial-row">
        <div class="data-item"><span>Abonado:</span> <strong style="color:#2d5a27; font-size:1.2rem" id="val-abonado">$0</strong></div>
        <div class="data-item" style="text-align:right"><span>Saldo Pendiente:</span> <strong style="color:#a33; font-size:1.2rem" id="val-restante">$0</strong></div>
      </div>
    </section>

    <footer class="policies-area">
      <p>Este documento digital es su soporte oficial. Aplican t√©rminos y condiciones.</p>
    </footer>
  </div>

  <div class="btn-container">
    <button class="download-btn" id="btnDownload">GUARDAR MI BOLETA</button>
  </div>

  <script>
    // 1. OBTENEMOS EL N√öMERO DE BOLETA DEL ENLACE (Ej: misitio.com/boleta?numero=1126)
    const urlParams = new URLSearchParams(window.location.search);
    const boletaParam = urlParams.get('numero') || "0000";
    document.getElementById('lbl-boleta').textContent = boletaParam;

    // 2. LA NUEVA MAGIA DE SEGURIDAD CON VERCEL
    async function verificarIdentidad() {
      const inputPhone = document.getElementById('inputPhone').value;
      const btn = document.getElementById('btnVerificar');
      const msgError = document.getElementById('errorMsg');
      
      btn.textContent = "Verificando...";
      btn.disabled = true;
      msgError.style.display = 'none';

      try {
        // AQU√ç ES DONDE HABLAMOS CON TU NUEVO CANDADO EN VERCEL
        const response = await fetch("https://api-rifas-prueba.vercel.app/api/verificar-boleta", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ numero_boleta: boletaParam, telefono: inputPhone })
        });

        if (!response.ok) throw new Error("Datos inv√°lidos");

        const data = await response.json();

        // 3. SI TODO SALE BIEN, LLENAMOS LA P√ÅGINA CON LOS DATOS REALES
        document.getElementById('val-numero').textContent = data.numero;
        document.getElementById('val-nombre').textContent = data.nombre;
        document.getElementById('val-apellido').textContent = data.apellido;
        document.getElementById('val-ciudad').textContent = data.ciudad;
        document.getElementById('val-telefono').textContent = data.telefono;

        // Formatear el dinero a pesos colombianos
        const formatoPlata = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });
        document.getElementById('val-abonado').textContent = formatoPlata.format(data.total);
        document.getElementById('val-restante').textContent = formatoPlata.format(data.restante);

        // 4. QUITAMOS EL CANDADO VISUAL CON UN EFECTO BONITO
        var overlay = document.getElementById('security-overlay');
        overlay.style.transition = "opacity 0.5s ease";
        overlay.style.opacity = '0';
        setTimeout(() => overlay.style.display = 'none', 500);

      } catch (error) {
        // SI SE EQUIVOCA, LE DAMOS UN AVISO DE ERROR
        msgError.style.display = 'block';
        msgError.textContent = "‚ùå El n√∫mero no coincide con el titular.";
        var box = document.querySelector('.security-box');
        box.style.transform = 'translateX(5px)';
        setTimeout(() => box.style.transform = 'translateX(-5px)', 100);
        setTimeout(() => box.style.transform = 'translateX(0)', 200);
      } finally {
        btn.textContent = "VER MI BOLETA";
        btn.disabled = false;
      }
    }

    // (Aqu√≠ puedes pegar la l√≥gica del html2canvas para descargar la imagen que ya ten√≠as)
  </script>
  </body>
</html>
