<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Boleta Virtual - Apartamento</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Playfair+Display:ital,wght@0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
      /* --- ESTILOS GENERALES --- */
      :root {
        --gold: #C5A059;
        --dark: #1a1a1a;
        --soft-wood: #F9F6F2;
        --white: #ffffff;
      }
      body {
        margin: 0; padding: 0;
        background: #e0e0e0;
        font-family: 'Montserrat', sans-serif;
        color: var(--dark);
        -webkit-tap-highlight-color: transparent;
      }
      .page-wrapper {
        max-width: 480px;
        margin: 0 auto;
        background: var(--white);
        overflow: hidden;
        box-shadow: 0 0 20px rgba(0,0,0,0.05);
        position: relative;
      }

      /* --- SECCI√ìN 1: PORTADA --- */
      .hero-section {
        position: relative;
        text-align: center;
        background: var(--dark);
        color: white;
        padding-bottom: 3rem;
      }
      
      .brand-logo {
        display: block;       
        margin: 10px auto 0;
        width: 100px;
        height: auto;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); 
        position: relative;
        z-index: 10;
      }

      .hero-bg-img {
        width: 100%;
        height: 380px;
        object-fit: cover;
        opacity: 0.7; 
        mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
        -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
      }
      
      .floating-info {
        margin-top: -140px;
        position: relative;
        z-index: 2;
        padding: 0 20px;
      }
      
      .ticket-number {
        font-family: 'Playfair Display', serif;
        font-size: 5rem;
        color: var(--gold);
        line-height: 0.9;
        margin: 10px 0;
        text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
        font-weight: 700;
      }
      .badge {
        display: inline-block;
        background: var(--gold);
        color: var(--dark);
        padding: 6px 18px;
        border-radius: 50px;
        font-size: 0.75rem;
        letter-spacing: 2px;
        font-weight: 700;
        box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      }

      /* --- SECCI√ìN 2: DATOS --- */
      .client-box {
        padding: 1.5rem;
        background: var(--soft-wood);
        margin: -20px 20px 30px;
        border-radius: 15px;
        position: relative;
        z-index: 5;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        border-bottom: 3px solid var(--gold);
      }
      .client-box h3 {
        font-family: 'Playfair Display', serif;
        margin-top: 0;
        color: var(--dark);
        font-size: 1.2rem;
        text-align: center;
        margin-bottom: 1.5rem;
      }
      .data-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        font-size: 0.9rem;
      }
      .data-item span { display: block; font-size: 0.75rem; color: #888; margin-bottom: 3px; }
      .data-item strong { display: block; font-size: 1rem; }
      .financial-row {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px dashed #ccc;
      }

      /* --- SECCI√ìN 3: GALER√çA INTERACTIVA --- */
      .interactive-gallery {
        padding: 0 20px 30px;
      }
      .gallery-title {
        font-family: 'Playfair Display', serif;
        text-align: center;
        font-size: 1.5rem;
        margin-bottom: 20px;
        color: var(--dark);
      }
      
      .main-image-viewer {
        width: 100%;
        height: 350px; 
        background: #f0f0f0;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 15px;
        position: relative;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      }
      .main-image-viewer img {
        width: 100%;
        height: 100%;
        object-fit: cover; 
        transition: opacity 0.3s ease-in-out;
      }
      .swipe-hint {
        position: absolute;
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.6);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
        pointer-events: none;
        opacity: 0.8;
      }

      .thumbnail-carousel {
        display: flex;
        gap: 10px;
        overflow-x: auto; 
        padding: 5px;
        scrollbar-width: none; 
        -webkit-overflow-scrolling: touch; 
      }
      .thumbnail-carousel::-webkit-scrollbar { display: none; }

      .thumb {
        flex: 0 0 70px; 
        height: 70px;
        border-radius: 10px;
        overflow: hidden;
        opacity: 0.5;
        transition: 0.3s;
        cursor: pointer;
        border: 2px solid transparent;
      }
      .thumb img { width: 100%; height: 100%; object-fit: cover; }
      .thumb.active {
        opacity: 1;
        border-color: var(--gold);
        transform: scale(1.05);
      }

      /* --- CARACTER√çSTICAS --- */
      .features {
        padding: 2rem 1.5rem;
        background: #fff;
        border-top: 1px solid #eee;
      }
      .features h3 {
        font-family: 'Playfair Display', serif;
        text-align: center;
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 1.3rem;
        color: var(--dark);
      }
      .features-grid {
        display: grid;
        grid-template-columns: 1fr 1fr; 
        gap: 12px;
      }
      .feature-card {
        background: var(--soft-wood);
        padding: 12px;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        border: 1px solid rgba(197, 160, 89, 0.2); 
        transition: transform 0.2s;
      }
      .feature-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      }
      .f-icon {
        font-size: 1.5rem;
        margin-bottom: 5px;
        display: block;
      }
      .f-title {
        font-weight: 700;
        font-size: 0.8rem;
        color: var(--dark);
        margin-bottom: 2px;
        display: block;
      }
      .f-desc {
        font-size: 0.65rem;
        color: #666;
        line-height: 1.2;
      }
      .policies-area { 
        padding: 30px 20px 80px; 
        font-size: 0.75rem; 
        background: #1a1a1a; 
        color: #aaa;
        text-align: center;
        line-height: 1.6;
      }

      .btn-container {
        padding: 15px 20px;
        position: fixed; 
        bottom: 0; left: 0; right: 0;
        background: rgba(255,255,255,0.98);
        z-index: 100;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        display: flex; justify-content: center;
      }
      .download-btn {
        width: 100%; max-width: 440px;
        padding: 1.1rem;
        background: var(--dark);
        color: var(--gold);
        border: none;
        border-radius: 50px;
        font-weight: 700;
        cursor: pointer;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 5px 15px rgba(197, 160, 89, 0.3);
        transition: transform 0.2s;
      }
      .download-btn:active { transform: scale(0.98); }

      /* --- EL CAMINITO (TIMELINE) --- */
      .roadmap-section {
        padding: 20px 15px; 
        background: #fff;
        border-top: 1px solid #eee;
        overflow: hidden; 
      }
      .section-title {
        font-family: 'Playfair Display', serif;
        text-align: center;
        font-size: 1.5rem;
        margin-bottom: 40px;
        color: var(--dark);
      }
      .timeline {
        position: relative;
        max-width: 100%;
        margin: 0 auto;
      }
      .timeline::before {
        content: '';
        position: absolute;
        top: 15px; 
        bottom: 30px; 
        left: 28px; 
        width: 4px; 
        background: var(--gold); 
        border: none; 
        z-index: 1;
        box-shadow: 0 0 15px rgba(197, 160, 89, 0.5); 
        border-radius: 10px; 
      }
      .timeline-item {
        position: relative;
        margin-bottom: 40px;
        padding-left: 75px; 
      }
      .timeline-item:last-child { margin-bottom: 0; }
      .t-circle {
        position: absolute;
        left: 5px; 
        top: 0;
        width: 46px; 
        height: 46px;
        background: var(--white);
        border: 3px solid var(--gold);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        z-index: 2; 
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      .t-circle.big {
        width: 56px;
        height: 56px;
        left: 0px; 
        background: var(--gold);
        color: white;
        border-color: var(--dark);
        font-size: 1.6rem;
        box-shadow: 0 0 0 5px rgba(197, 160, 89, 0.2); 
      }
      .t-date {
        font-family: 'Montserrat', sans-serif;
        font-weight: 700;
        color: var(--gold);
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 1px;
        margin-bottom: 5px;
        display: block;
        padding-top: 5px; 
      }
      .weekend-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 5px;
        margin-top: 10px;
      }
      .weekend-tag {
        background: #f0f0f0;
        border-radius: 4px;
        padding: 4px;
        text-align: center;
        font-size: 0.7rem;
        color: #555;
      }
      .weekend-tag.active {
        background: #e8f5e9;
        color: #2d5a27;
        font-weight: bold;
        border: 1px solid #c8e6c9;
      }

      /* --- CAJAS DE INFORMACI√ìN --- */
      .info-boxes {
        background: #f9f9f9;
        padding: 30px 20px;
      }
      .info-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        border-left: 4px solid var(--dark);
      }
      .info-card h4 {
        margin: 0 0 10px;
        font-size: 1rem;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .rule-list {
        margin: 0; padding-left: 20px;
        font-size: 0.85rem;
        color: #555;
      }
      .rule-list li { margin-bottom: 8px; }
      
      .lottery-banner {
        text-align: center;
        padding: 15px;
        background: #e3f2fd;
        border-radius: 8px;
        color: #0d47a1;
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 20px;
        border: 1px solid #bbdefb;
      }

      /* --- FILTRO DE SEGURIDAD --- */
      #security-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #f4f4f4;
        z-index: 99999; 
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        text-align: center;
      }
      .security-box {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        max-width: 350px;
        width: 100%;
        border-top: 5px solid var(--gold);
      }
      .security-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        display: block;
      }
      .security-title {
        font-family: 'Playfair Display', serif;
        font-size: 1.5rem;
        color: var(--dark);
        margin-bottom: 10px;
      }
      .security-desc {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 20px;
      }
      .security-input {
        width: 100%;
        padding: 12px;
        font-size: 1.1rem;
        border: 2px solid #eee;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 15px;
        outline: none;
        transition: 0.3s;
        box-sizing: border-box; 
      }
      .security-input:focus { border-color: var(--gold); }
      .security-btn {
        background: var(--dark);
        color: var(--gold);
        border: none;
        padding: 12px 25px;
        font-size: 1rem;
        border-radius: 50px;
        cursor: pointer;
        font-weight: bold;
        width: 100%;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .error-msg {
        color: #d32f2f;
        font-size: 0.8rem;
        margin-top: 10px;
        display: none; 
        font-weight: bold;
      }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  </head>
  <body>

    <div id="security-overlay">
      <div class="security-box">
        <span class="security-icon">üîí</span>
        <h2 class="security-title">Zona Segura</h2>
        <p class="security-desc">Por seguridad, confirma el n√∫mero de celular registrado en la boleta <strong id="lbl-boleta" style="color:var(--gold);">---</strong> para visualizarla.</p>
        
        <input type="tel" id="inputPhone" class="security-input" placeholder="Ingresa tu celular aqu√≠" inputmode="numeric">
        
        <button class="security-btn" id="btnVerificar" onclick="verificarIdentidad()">VER MI BOLETA</button>
        
        <p id="errorMsg" class="error-msg">‚ùå El n√∫mero no coincide. Intenta de nuevo.</p>
        
        <p style="margin-top:20px; font-size:0.75rem; color:#aaa;">
          ¬øNecesitas ayuda? <a href="https://wa.me/573107334957" style="color:var(--gold); text-decoration:none;">Cont√°ctanos</a>
        </p>
      </div>
    </div>

    <div class="page-wrapper" id="captureArea">
      
      <section class="hero-section">
        <img src="https://losplata.s3.us-east-2.amazonaws.com/sala+h.png" class="hero-bg-img" crossOrigin="anonymous">
        
        <div class="floating-info">
          <span class="badge">BOLETA OFICIAL DIGITAL</span>
          <div class="ticket-number" id="val-numero">0000</div>
          
          <p style="font-family: 'Playfair Display', serif; font-style: italic; margin-top: 5px; opacity: 0.9;">Tu llave al apartamento so√±ado</p>

          <img src="https://losplata.s3.us-east-2.amazonaws.com/Logo.png" class="brand-logo" crossOrigin="anonymous" alt="Logo Los Plata">
        </div>
      </section>

      <section class="client-box">
        <h3>TITULAR DE LA BOLETA</h3>
        <div class="data-grid">
          <div class="data-item"><span>Titular:</span> <strong><span id="val-nombre">Cargando...</span> <span id="val-apellido"></span></strong></div>
          <div class="data-item"><span>Ciudad:</span> <strong><span id="val-ciudad">---</span></strong></div>
          <div class="data-item"><span>Tel√©fono:</span> <strong><span id="val-telefono">---</span></strong></div>
          <div class="data-item"><span>Sorteo:</span> <strong>Loter√≠a de Boyac√°</strong></div>
        </div>
        <div class="financial-row">
          <div class="data-item"><span>Abonado:</span> <strong style="color:#2d5a27; font-size:1.2rem" id="val-abonado">$0</strong></div>
          <div class="data-item" style="text-align:right"><span>Saldo Pendiente:</span> <strong style="color:#a33; font-size:1.2rem" id="val-restante">$0</strong></div>
        </div>
      </section>

      <section class="interactive-gallery">
        <h2 class="gallery-title">Conoce el apartamento</h2>
        
        <div class="main-image-viewer" id="mainImageViewer">
          <img id="activeImage" src="https://losplata.s3.us-east-2.amazonaws.com/sala+h.png" crossOrigin="anonymous">
          <div class="swipe-hint">‚Üî Desliza para ver m√°s</div>
        </div>

        <div class="thumbnail-carousel" id="thumbCarousel">
          <div class="thumb active"><img src="https://losplata.s3.us-east-2.amazonaws.com/sala+h.png" crossOrigin="anonymous"></div>
          <div class="thumb"><img src="https://losplata.s3.us-east-2.amazonaws.com/sala+2+h.png" crossOrigin="anonymous"></div>
          <div class="thumb"><img src="https://losplata.s3.us-east-2.amazonaws.com/comedor+v.png" crossOrigin="anonymous"></div>
          <div class="thumb"><img src="https://losplata.s3.us-east-2.amazonaws.com/cocina+h.png" crossOrigin="anonymous"></div>
          <div class="thumb"><img src="https://losplata.s3.us-east-2.amazonaws.com/habitacion+1+h.png" crossOrigin="anonymous"></div>
          <div class="thumb"><img src="https://losplata.s3.us-east-2.amazonaws.com/habitacion+1+v.png" crossOrigin="anonymous"></div>
          <div class="thumb"><img src="https://losplata.s3.us-east-2.amazonaws.com/habitacion+1.2+v.png" crossOrigin="anonymous"></div>
          <div class="thumb"><img src="https://losplata.s3.us-east-2.amazonaws.com/jacuzzi+v.png" crossOrigin="anonymous"></div>
          <div class="thumb"><img src="https://losplata.s3.us-east-2.amazonaws.com/habitaci%C3%B3n+2+h.png" crossOrigin="anonymous"></div>
          <div class="thumb"><img src="https://losplata.s3.us-east-2.amazonaws.com/oficibna+v.png" crossOrigin="anonymous"></div>
        </div>
      </section>

      <section class="features">
        <h3>Todo esto puede ser tuyo:</h3>
        
        <div class="features-grid">
          <div class="feature-card">
            <span class="f-icon">üè°</span>
            <span class="f-title">67m¬≤ y 2 Ba√±os</span>
            <span class="f-desc">Apartamento amplio con pisos de lujo en porcelanato.</span>
          </div>

          <div class="feature-card">
            <span class="f-icon">üõèÔ∏è</span>
            <span class="f-title">3 Alcobas</span>
            <span class="f-desc">La principal tiene ba√±o privado y <strong>Jacuzzi</strong>.</span>
          </div>

          <div class="feature-card">
            <span class="f-icon">üñ•Ô∏è</span>
            <span class="f-title">Oficina Dotada</span>
            <span class="f-desc">Una alcoba equipada con computador, impresora y silla.</span>
          </div>

          <div class="feature-card">
            <span class="f-icon">üç≥</span>
            <span class="f-title">Cocina Integral</span>
            <span class="f-desc">Totalmente lista con horno y extractor de olores.</span>
          </div>

          <div class="feature-card">
            <span class="f-icon">üõãÔ∏è</span>
            <span class="f-title">Sala y Comedor</span>
            <span class="f-desc">Zona social amplia con centro de entretenimiento.</span>
          </div>

          <div class="feature-card">
            <span class="f-icon">üöò</span>
            <span class="f-title">Parqueadero</span>
            <span class="f-desc">Sitio propio y seguro incluido para su veh√≠culo.</span>
          </div>
        </div>
      </section>

      <section class="roadmap-section">
        <h3 class="section-title">üèÜ Fechas y premios</h3>
        
        <div class="timeline">
          
          <div class="timeline-item">
            <div class="t-circle">üóìÔ∏è</div>
            <span class="t-date">CADA FIN DE SEMANA</span>
            <h4 class="t-title">8 obsequios, cada uno de 5 MILLONES</h4>
            <p class="t-desc">Tiene 8 oportunidades seguidas para ganar efectivo r√°pido.</p>
            <div class="weekend-grid">
              <div class="weekend-tag active">31 ENE</div>
              <div class="weekend-tag active">7 FEB</div>
              <div class="weekend-tag active">14 FEB</div>
              <div class="weekend-tag active">21 FEB</div>
              <div class="weekend-tag active">7 MAR</div>
              <div class="weekend-tag active">14 MAR</div>
              <div class="weekend-tag active">21 MAR</div>
              <div class="weekend-tag active">28 MAR</div>
            </div>
          </div>

          <div class="timeline-item">
            <div class="t-circle">üíµ</div>
            <span class="t-date">28 DE FEBRERO</span>
            <h4 class="t-title">El "Sueldazo" mensual</h4>
            <p class="t-desc">Gane $1.500.000 mensuales durante 6 meses.</p>
          </div>

          <div class="timeline-item">
            <div class="t-circle big">üè¢</div>
            <span class="t-date" style="font-size: 1rem; color:var(--dark);">04 DE ABRIL</span>
            <h4 class="t-title" style="font-size:1.3rem; color:var(--gold);">GRAN FINAL: APARTAMENTO</h4>
            <p class="t-desc">El premio mayor: Apartamento totalmente amoblado.</p>
          </div>

        </div>
      </section>

      <section class="info-boxes">
        
        <div class="lottery-banner">
          ü§û Todos los sorteos juegan con la <strong>Loter√≠a de Boyac√°</strong>
        </div>

        <div class="info-card">
          <h4>üìã Condiciones para Ganar</h4>
          <ul class="rule-list">
            <li><strong>Para los $5 Millones (Semanal):</strong> Debe abonar $20.000 cada semana puntualmente.</li>
            <li><strong>Para el Sueldazo (Feb 28):</strong> Debe tener un abono total de $100.000 para esa fecha.</li>
            <li><strong>Para el Apartamento (Abr 04):</strong> La boleta debe estar totalmente pagada (Paz y Salvo).</li>
          </ul>
        </div>
        
      </section>

      <footer class="policies-area">
        <img src="https://cdn-icons-png.flaticon.com/512/5460/5460474.png" width="40" style="opacity:0.5; margin-bottom:10px;">
        <p>Este documento digital es su soporte oficial de participaci√≥n en la Rifa "Los Plata". El premio mayor se sortear√° el 04 DE ABRIL DE 2026 con la Loter√≠a de Boyac√°. Aplican t√©rminos y condiciones. Conserve los comprobantes de pago.</p>
      </footer>

    </div>
    
    <div class="btn-container">
      <button class="download-btn" id="btnDownload">GUARDAR MI BOLETA</button>
    </div>

    <script>
      // --- 1. CONFIGURACI√ìN INICIAL (Motor Vercel Inteligente) ---
      let boletaParam = "0000";
      const urlParams = new URLSearchParams(window.location.search);
      
      if (urlParams.has('numero')) {
        boletaParam = urlParams.get('numero'); // Lee el enlace viejo con "?"
      } else {
        // Lee el enlace VIP nuevo (/boleta/1234)
        const ruta = window.location.pathname.split('/');
        const ultimoValor = ruta[ruta.length - 1];
        if (!isNaN(ultimoValor) && ultimoValor.trim() !== "") {
          boletaParam = ultimoValor;
        }
      }
      document.getElementById('lbl-boleta').textContent = boletaParam;

      async function verificarIdentidad() {
        const inputPhone = document.getElementById('inputPhone').value;
        const btn = document.getElementById('btnVerificar');
        const msgError = document.getElementById('errorMsg');
        
        btn.textContent = "Verificando...";
        btn.disabled = true;
        msgError.style.display = 'none';

        try {
          // LLAMADA A TU CEREBRO EN VERCEL
          const response = await fetch("/api/verificar-boleta", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ numero_boleta: boletaParam, telefono: inputPhone })
          });

          if (!response.ok) throw new Error("Datos inv√°lidos");
          const data = await response.json();

          // LLENAR LOS DATOS EN EL DISE√ëO ORIGINAL
          document.getElementById('val-numero').textContent = data.numero;
          document.getElementById('val-nombre').textContent = data.nombre;
          document.getElementById('val-apellido').textContent = data.apellido;
          document.getElementById('val-ciudad').textContent = data.ciudad;
          document.getElementById('val-telefono').textContent = data.telefono;

          const formatoPlata = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });
          document.getElementById('val-abonado').textContent = formatoPlata.format(data.total);
          document.getElementById('val-restante').textContent = formatoPlata.format(data.restante);

          // QUITAR CANDADO
          var overlay = document.getElementById('security-overlay');
          overlay.style.transition = "opacity 0.5s ease";
          overlay.style.opacity = '0';
          setTimeout(() => overlay.style.display = 'none', 500);

        } catch (error) {
          msgError.style.display = 'block';
          msgError.textContent = "‚ùå El n√∫mero no coincide con el titular.";
          var box = document.querySelector('.security-box');
          box.style.transform = 'translateX(5px)';
          setTimeout(() => box.style.transform = 'translateX(-5px)', 100);
          setTimeout(() => box.style.transform = 'translateX(0)', 200);
        } finally {
          btn.textContent = "VER MI BOLETA";
          btn.disabled = false;
        }
      }

      // --- 2. L√ìGICA DE LA GALER√çA INTERACTIVA (Tuya original) ---
      (function(){
        const mainImg = document.getElementById('activeImage');
        const viewer = document.getElementById('mainImageViewer');
        const thumbs = document.querySelectorAll('.thumb');
        let currentIndex = 0;
        const totalImages = thumbs.length;

        function setActiveImage(index) {
          mainImg.style.opacity = 0.5;
          setTimeout(() => {
            mainImg.src = thumbs[index].querySelector('img').src;
            mainImg.style.opacity = 1;
            thumbs.forEach(t => t.classList.remove('active'));
            thumbs[index].classList.add('active');
            thumbs[index].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            currentIndex = index;
          }, 150);
        }

        thumbs.forEach((thumb, index) => {
          thumb.addEventListener('click', () => setActiveImage(index));
        });

        let touchStartX = 0;
        let touchEndX = 0;

        viewer.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
        viewer.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); }, {passive: true});

        function handleSwipe() {
          const threshold = 50;
          if (touchEndX < touchStartX - threshold) { let nextIndex = (currentIndex + 1) % totalImages; setActiveImage(nextIndex); }
          if (touchEndX > touchStartX + threshold) { let prevIndex = (currentIndex - 1 + totalImages) % totalImages; setActiveImage(prevIndex); }
        }
      })();

      // --- 3. L√ìGICA DE DESCARGA HTML2CANVAS (Tuya original adaptada) ---
      (function(){
        const btn = document.getElementById('btnDownload');
        const area = document.getElementById('captureArea');

        btn.addEventListener('click', async () => {
          const originalText = btn.textContent;
          btn.disabled = true;
          btn.textContent = 'Generando imagen...';
          btn.style.opacity = 0.7;
          
          // Obtenemos el n√∫mero directamente del texto en pantalla para nombrar el archivo
          const numeroBoleta = document.getElementById('val-numero').textContent || boletaParam;
          
          const hint = document.querySelector('.swipe-hint');
          if(hint) hint.style.display = 'none';

          try {
            await new Promise(r => setTimeout(r, 300));

            const canvas = await html2canvas(area, {
              scale: 2,
              useCORS: true,
              allowTaint: true,
              backgroundColor: "#ffffff",
              scrollY: 0,
              windowHeight: area.scrollHeight + 100,
              onclone: (clonedDoc) => {
                  const clonedImg = clonedDoc.getElementById('activeImage');
                  clonedImg.style.opacity = 1;
              }
            });

            const link = document.createElement('a');
            link.download = `Boleta_Apto_N${numeroBoleta}.png`;
            link.href = canvas.toDataURL('image/png', 0.9);
            link.click();
            
            btn.textContent = '¬°Imagen Guardada! ‚úÖ';
          } catch (e) {
            console.error("Error en captura:", e);
            btn.textContent = 'Error al generar. Intente nuevamente.';
            alert('Hubo un problema generando la imagen. Por favor verifique su conexi√≥n e intente de nuevo.');
          } finally {
            if(hint) hint.style.display = 'block';
            setTimeout(() => {
              btn.disabled = false;
              btn.textContent = originalText;
              btn.style.opacity = 1;
            }, 3000);
          }
        });
      })();
    </script>
  </body>
</html>
