<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>Admin Los Plata</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f9fafb;
      --card: #ffffff;
      --ink: #111827;
      --ink-2: #4b5563;
      --muted: #9ca3af;
      --border: #e5e7eb;
      --border-focus: #d1d5db;
      --accent: #10b981;
      --accent-hover: #059669;
      --accent-bg: #ecfdf5;
      --danger: #ef4444;
      --danger-bg: #fef2f2;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --shadow-lg: 0 10px 25px -3px rgba(0, 0, 0, 0.05);
      --radius: 8px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; 
      background: var(--bg);
      font-family: 'Inter', system-ui, -apple-system, sans-serif; 
      color: var(--ink); 
      padding-bottom: 80px;
      line-height: 1.5;
    }
    
    .shell { max-width: 580px; margin: 20px auto; padding: 0 20px; display: none; opacity: 0; transition: opacity 0.4s ease; }
    .shell.visible { display: block; opacity: 1; }
    
    /* Buscador Superior - Minimalista */
    .top-search-bar { position: sticky; top: 0; z-index: 100; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border); padding: 12px 20px; transition: all 0.5s ease; }
    .top-search-bar.hero-mode { position: fixed; top: 45%; left: 50%; transform: translate(-50%, -50%); width: 100%; max-width: 500px; background: transparent; border-bottom: none; padding: 0; z-index: 1000; }
    
    .search-container { max-width: 580px; margin: 0 auto; display: flex; gap: 8px; transition: all 0.3s ease; }
    .main-input { width: 100%; border: 1px solid var(--border); border-radius: var(--radius); padding: 12px 16px; font-size: 0.95rem; outline: none; transition: all 0.2s; background: var(--card); color: var(--ink); font-family: inherit; }
    .main-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-bg); }
    
    .hero-mode .main-input { padding: 16px 24px; font-size: 1.05rem; border-radius: 12px; box-shadow: var(--shadow-lg); text-align: center; border: 1px solid var(--border); }
    .search-btn { background: var(--ink); color: #fff; border: none; border-radius: var(--radius); padding: 0 16px; font-weight: 500; cursor: pointer; transition: background 0.2s; }
    .search-btn:hover { background: #000; }
    .hero-mode .search-btn { display: none; }
    
    .hero-welcome-text { text-align: center; margin-bottom: 24px; opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.4s ease; position: absolute; top: -100px; left: 0; right: 0; }
    .hero-mode .hero-welcome-text { opacity: 1; visibility: visible; transform: translateY(0); position: relative; top: auto; }
    .hero-title { font-size: 1.5rem; font-weight: 600; letter-spacing: -0.02em; margin: 0; color: var(--ink); }
    .hero-subtitle { font-size: 0.9rem; color: var(--muted); margin: 4px 0 0 0; }

    /* Barra del Asesor */
    .user-info-bar { text-align: center; margin-top: 10px; font-size: 0.8rem; color: var(--ink-2); transition: all 0.3s ease; }
    .hero-mode .user-info-bar { position: fixed; top: 20px; right: 20px; margin: 0; background: var(--card); padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
    .nav-link { cursor: pointer; color: var(--ink-2); text-decoration: none; margin-left: 12px; transition: color 0.2s; }
    .nav-link:hover { color: var(--ink); }

    /* Tarjetas y Secciones */
    .section-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow-sm); padding: 24px; margin-bottom: 20px; }
    .section-title { font-size: 0.85rem; font-weight: 600; color: var(--ink-2); text-transform: uppercase; letter-spacing: 0.05em; margin: 0 0 16px 0; padding-bottom: 12px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    
    .vertical-form { display: flex; flex-direction: column; gap: 14px; }
    label { display: block; font-weight: 500; color: var(--ink-2); margin: 0 0 4px; font-size: 0.85rem; }
    .field { display: flex; align-items: center; gap: 8px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 12px; transition: all 0.2s; }
    .field:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-bg); }
    .pill { flex: 1; border: 0; outline: 0; font-size: 0.9rem; background: transparent; color: var(--ink); width: 100%; font-family: inherit; }
    
    /* Pastillas de Números */
    .num-wrap { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .num-pill { background: var(--bg); border: 1px solid var(--border-focus); border-radius: var(--radius); padding: 6px 10px; display: flex; gap: 8px; align-items: center; width: fit-content; }
    .num-pill input { width: 45px; border: 0; outline: 0; background: transparent; font-size: 1rem; font-weight: 600; color: var(--ink); text-align: center; font-family: inherit; }
    .chip-del { border: none; background: transparent; color: var(--muted); font-size: 1rem; cursor: pointer; padding: 0 4px; transition: color 0.2s; }
    .chip-del:hover { color: var(--danger); }
    .btn-add { border: 1px dashed var(--border-focus); background: transparent; color: var(--ink-2); border-radius: var(--radius); padding: 4px 12px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
    .btn-add:hover { background: var(--bg); color: var(--ink); }

    /* Botones */
    .cta { display: block; width: 100%; border: none; border-radius: var(--radius); padding: 12px; font-weight: 500; font-size: 0.95rem; background: var(--ink); color: #fff; cursor: pointer; text-align: center; margin-top: 8px; transition: all 0.2s; font-family: inherit; }
    .cta:hover { background: #000; box-shadow: var(--shadow-md); }
    .cta:active { transform: translateY(1px); }
    .cta-secondary { background: var(--bg); color: var(--ink); border: 1px solid var(--border); }
    .cta-secondary:hover { background: var(--border); color: var(--ink); }

    /* Modal Overlay */
    .modal-overlay { position: fixed; inset: 0; background: rgba(17, 24, 39, 0.4); backdrop-filter: blur(4px); z-index: 2000; display: none; align-items: center; justify-content: center; }
    .modal-card { background: var(--card); width: 90%; max-width: 380px; border-radius: 16px; padding: 32px 24px; text-align: center; box-shadow: var(--shadow-lg); border: 1px solid var(--border); }
    #loginOverlay { background: var(--bg); z-index: 10000; display: flex; } 
    .modal-title { font-size: 1.25rem; font-weight: 600; margin: 0 0 8px 0; color: var(--ink); }
    
    .hint { margin-top: 8px; text-align: center; color: var(--muted); font-size: 0.8rem; }
    .hint.err { color: var(--danger); }
    
    /* Selector de Modos (Separar / Abonar) */
    .mode-switch { display: flex; background: var(--bg); border-radius: var(--radius); padding: 4px; margin-bottom: 20px; border: 1px solid var(--border); }
    .mode-btn { flex: 1; border: none; background: transparent; padding: 8px; border-radius: 6px; font-weight: 500; color: var(--muted); cursor: pointer; transition: all 0.2s; font-size: 0.85rem; font-family: inherit; }
    .mode-btn.active { background: var(--card); color: var(--ink); box-shadow: var(--shadow-sm); border: 1px solid var(--border); }
    
    /* Zona OCR Drop */
    .ocr-drop { border: 1px dashed var(--border-focus); background: var(--bg); border-radius: var(--radius); padding: 16px; text-align: center; font-weight: 400; color: var(--ink-2); cursor: pointer; margin-bottom: 12px; font-size: 0.8rem; transition: all 0.2s; }
    .ocr-drop:hover { border-color: var(--muted); background: var(--card); }

    /* Utilidades */
    .view-section { display: none; animation: fadeIn 0.3s ease; }
    .view-section.active { display: block; }
    .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: var(--bg); border: 1px solid var(--border); color: var(--ink-2); font-weight: 500; }
    .badge.success { background: var(--accent-bg); color: var(--accent-hover); border-color: #a7f3d0; }
    .badge.danger { background: var(--danger-bg); color: var(--danger); border-color: #fecaca; }

    @keyframes fadeIn{from{opacity:0} to{opacity:1}}
  </style>
</head>
<body>

  <div id="loginOverlay" class="modal-overlay">
    <div class="modal-card">
      <h1 class="modal-title">Acceso al Sistema</h1>
      <p style="color:var(--muted); font-size:0.9rem; margin-bottom: 20px;">Ingresa tu clave de administrador</p>
      <div class="field" style="margin-bottom:20px;">
        <input id="loginPwd" type="password" class="pill" placeholder="Contraseña..." style="text-align:center">
      </div>
      <button id="btnLogin" class="cta">Ingresar</button>
      <div id="loginMsg" class="hint"></div>
    </div>
  </div>

  <div class="top-search-bar hero-mode" id="topBar" style="display:none">
    <div class="hero-welcome-text">
        <h1 class="hero-title">Sistema Unificado</h1>
        <p class="hero-subtitle">Busca número de boleta, teléfono o pega datos</p>
    </div>
    <div class="search-container">
      <input type="text" id="smartInput" class="main-input" placeholder="Buscar o pegar..." autocomplete="off">
      <button id="btnSearch" class="search-btn">Buscar</button>
    </div>
    <div class="user-info-bar">
      <span id="asesorDisplay" style="font-weight:500; color:var(--ink); margin-right:12px;">Asesor</span>
      <span class="nav-link" onclick="switchView('view-bancos')">Subir Bancos</span>
      <span id="btnLogout" class="nav-link">Cerrar sesión</span>
    </div>
    <div id="searchFeedback" class="hint" style="margin: 8px 0 0 0; min-height: 20px;"></div>
  </div>

  <div class="shell" id="appShell">

    <div id="view-bancos" class="view-section">
      <div class="section-card">
        <div class="section-title">Cargar Extracto Bancolombia</div>
        <p style="font-size: 0.85rem; color: var(--ink-2); margin-bottom: 16px;">Sube el archivo .CSV descargado de la Sucursal Virtual. El sistema procesará el extracto automáticamente.</p>
        <div class="vertical-form">
          <div class="field" style="background:var(--bg); border: 1px dashed var(--muted); padding: 20px; justify-content: center;">
            <input type="file" id="fileBancos" accept=".csv" style="font-size: 0.9rem;">
          </div>
          <button id="btnProcesarBancos" class="cta" onclick="procesarCSVBancos()">Procesar y Subir</button>
        </div>
      </div>
    </div>
    
    <div id="view-venta" class="view-section">
      <div class="section-card">
        <div class="section-title"><span>Boletas Seleccionadas</span><button id="btnAddNum" class="btn-add">+ Añadir</button></div>
        <div id="numList" class="num-wrap"></div>
      </div>

      <div class="section-card">
        <div class="section-title">Datos del Cliente</div>
        <div class="vertical-form">
          <div><label>Nombre</label><div class="field"><input id="v_nombre" class="pill" type="text"></div></div>
          <div><label>Apellido</label><div class="field"><input id="v_apellido" class="pill" type="text"></div></div>
          <div><label>Teléfono</label><div class="field"><input id="v_telefono" class="pill" type="tel"></div></div>
          <div><label>Ciudad</label><div class="field"><input id="v_ciudad" class="pill" type="text"></div></div>
        </div>
      </div>

      <div class="mode-switch">
        <button id="btnModeSeparar" class="mode-btn active" onclick="setMode('separar')">Solo Separar ($0)</button>
        <button id="btnModeAbono" class="mode-btn" onclick="setMode('abono')">Registrar con Abono</button>
      </div>

      <div id="paymentSections" style="display: none;">
        <div class="section-card">
          <div class="section-title">Buscar Pago en Bancos</div>
          <div class="vertical-form">
            <p style="font-size: 0.8rem; color: var(--muted); margin-top: -10px;">Llena al menos un dato para filtrar:</p>
            <div style="display: flex; gap: 10px;">
              <div style="flex: 1;">
                <label>Teléfono Origen</label>
                <div class="field"><input id="t_ref" class="pill" type="tel" placeholder="Ej: 311..."></div>
              </div>
              <div style="flex: 1;">
                <label>Valor exacto</label>
                <div class="field"><input id="t_monto" class="pill" type="number" placeholder="Ej: 50000"></div>
              </div>
            </div>
            <div>
              <label>Fecha de transacción</label>
              <div class="field"><input id="t_fecha" class="pill" type="date"></div>
            </div>
            <button id="btnBuscarInteligente" type="button" class="cta cta-secondary" onclick="buscarTransferenciasUI('btnBuscarInteligente', 't_fecha', 't_monto', 't_ref', 'feedbackTransfer', 'v_referenciaAbono', 'v_primerAbono', 'v_metodoPago')">Buscar Transferencia</button>
          </div>
          <div id="feedbackTransfer" class="hint"></div>
        </div>

        <div class="section-card">
          <div class="section-title">Detalle del Abono</div>
          <div id="ocrDrop" class="ocr-drop">
             Pegar comprobante aquí (Ctrl+V) para leer referencia<br>
             <span id="ocrStatus" style="color:var(--ink); font-weight:500; display:block; margin-top:4px;"></span>
          </div>

          <div class="vertical-form">
            <div><label>Monto a Abonar</label><div class="field"><input id="v_primerAbono" class="pill" type="number" min="0" value="0"></div></div>
            <div>
              <label>Método / Plataforma</label>
              <div class="field">
                <input id="v_metodoPago" list="l_metodos" class="pill" type="text" placeholder="Nequi, Bancolombia...">
                <datalist id="l_metodos"><option value="Nequi"></option><option value="Bancolombia"></option><option value="Efectivo"></option></datalist>
              </div>
            </div>
            <div>
              <label>Referencia</label>
              <div style="display:flex; gap:8px;">
                <div class="field" style="flex:1"><input id="v_referenciaAbono" class="pill" type="text" placeholder="N° de comprobante"></div>
                <button id="btnForzarPendiente" type="button" class="cta cta-secondary" style="margin:0; width:auto; padding:0 12px; font-size:0.8rem;" title="Marcar como pendiente">Pendiente</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top: 24px;">
          <button id="btnRegistrarVenta" class="cta" style="padding: 16px;">Confirmar Separado ($0)</button>
          <input id="v_contrasena" type="hidden">
      </div>
    </div>

    <div id="view-cliente" class="view-section">
      <div class="section-card" style="padding: 0; overflow: hidden;">
        <div id="cliente-info-render"></div>
      </div>

      <div class="section-card">
         <div class="section-title">Buscar Pago en Bancos</div>
         <div class="vertical-form">
            <div style="display: flex; gap: 10px;">
              <div style="flex: 1;"><label>Teléfono Origen</label><div class="field"><input id="t_ref_abono" class="pill" type="tel"></div></div>
              <div style="flex: 1;"><label>Valor exacto</label><div class="field"><input id="t_monto_abono" class="pill" type="number"></div></div>
            </div>
            <div><label>Fecha de transacción</label><div class="field"><input id="t_fecha_abono" class="pill" type="date"></div></div>
            <button id="btnBuscarInteligenteAbono" type="button" class="cta cta-secondary" onclick="buscarTransferenciasUI('btnBuscarInteligenteAbono', 't_fecha_abono', 't_monto_abono', 't_ref_abono', 'feedbackTransferAbono', 'a_ref', 'a_monto', 'a_metodo')">Buscar Transferencia</button>
         </div>
         <div id="feedbackTransferAbono" class="hint"></div>
      </div>

      <div class="section-card">
          <div class="section-title">Registrar Nuevo Abono</div>
          <div id="ocrDropAbono" class="ocr-drop">
             Pegar comprobante aquí (Ctrl+V) para leer referencia<br>
             <span id="ocrStatusAbono" style="color:var(--ink); font-weight:500; display:block; margin-top:4px;"></span>
          </div>

          <div class="vertical-form">
             <div>
               <label>Boletas a abonar:</label>
               <div id="boletas-checkbox-container" style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px;"></div>
             </div>
             <div><label>Valor Total</label><div class="field"><input type="number" id="a_monto" class="pill" placeholder="0"></div></div>
             <div><label>Método de Pago</label><div class="field"><input id="a_metodo" list="l_metodos" class="pill" type="text"></div></div>
             <div>
               <label>Referencia</label>
               <div style="display:flex; gap:8px;">
                 <div class="field" style="flex:1"><input type="text" id="a_ref" class="pill"></div>
                 <button id="btnForzarPendienteAbono" type="button" class="cta cta-secondary" style="margin:0; width:auto; padding:0 12px; font-size:0.8rem;">Pendiente</button>
               </div>
             </div>
          </div>
          <button id="btnRegistrarAbono" class="cta" onclick="registrarAbono()" style="margin-top:24px; padding:16px;">Registrar Abono</button>
      </div>
    </div>
  </div>

  <div id="modalResult" class="modal-overlay">
    <div class="modal-card">
      <h3 id="mTitle" class="modal-title">Título</h3>
      <p id="mMsg" style="color:var(--ink-2); margin-bottom:24px; font-size: 0.9rem; line-height: 1.6;">Mensaje</p>
      <button id="mBtn" class="cta" style="width: auto; padding: 10px 32px; margin: 0 auto;">Aceptar</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  
  <script>
    // --- LÓGICA JAVASCRIPT INTACTA ---
    const $ = id => document.getElementById(id);
    const feedback = $('searchFeedback');
    const topBar = $('topBar');
    const appShell = $('appShell');

    function activateAppMode() { topBar.classList.remove('hero-mode'); appShell.classList.add('visible'); }
    function activateHeroMode() { topBar.classList.add('hero-mode'); appShell.classList.remove('visible'); $('smartInput').value = ''; $('smartInput').focus(); setMode('separar'); }

    let modoVenta = 'separar'; 
    function setMode(mode) {
      modoVenta = mode;
      const btnAbono = $('btnModeAbono'); const btnSeparar = $('btnModeSeparar');
      const paySection = $('paymentSections'); const btnReg = $('btnRegistrarVenta');
      if (mode === 'separar') {
        btnSeparar.classList.add('active'); btnAbono.classList.remove('active');
        paySection.style.display = 'none';
        btnReg.textContent = 'Confirmar Separado ($0)'; 
      } else {
        btnAbono.classList.add('active'); btnSeparar.classList.remove('active');
        paySection.style.display = 'block'; 
        btnReg.textContent = 'Registrar Venta'; 
      }
    }

    const numList = $('numList');
    function makeNumPill(value=''){
      const wrap = document.createElement('div'); wrap.className='num-pill';
      const inp = document.createElement('input'); inp.type='text'; inp.maxLength=4; inp.value=value;
      const del = document.createElement('button'); del.className='chip-del'; del.innerHTML='&times;';
      del.onclick = ()=>{ wrap.remove(); if(!numList.children.length) addDefaultPill(); };
      wrap.append(inp, del); return wrap;
    }
    function addDefaultPill(){ numList.appendChild(makeNumPill()); }
    $('btnAddNum').onclick = ()=> numList.appendChild(makeNumPill());

    const STORAGE_KEY = 'asesor_pwd';
    function initLogin(){ const s=localStorage.getItem(STORAGE_KEY); if(s) verifyLogin(s,true); }
    $('btnLogin').onclick = ()=> verifyLogin($('loginPwd').value);
    $('btnLogout').onclick = ()=> { localStorage.removeItem(STORAGE_KEY); location.reload(); };
    
    async function verifyLogin(pwd, auto=false){
      if(!pwd) { 
          if(!auto) alert("Por favor ingresa la contraseña."); 
          return; 
      }
      
      const btn = $('btnLogin');
      const msg = $('loginMsg');
      
      if(!auto) {
          btn.textContent = 'Verificando...';
          btn.disabled = true;
          msg.textContent = '';
      }

      try {
          const req = await fetch('/api/admin/login', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ contrasena: pwd })
          });
          const res = await req.json();

          if(!auto) {
              btn.textContent = 'Ingresar';
              btn.disabled = false;
          }

          if(res.status === 'ok') {
              localStorage.setItem(STORAGE_KEY, pwd); 
              $('loginOverlay').style.display='none'; 
              topBar.style.display='block'; 
              
              $('asesorDisplay').textContent = "Asesor: " + res.asesor; 
              $('v_contrasena').value = pwd; 
              $('smartInput').focus();
          } else {
              if(!auto) msg.innerHTML = 'Contraseña incorrecta';
              msg.classList.add('err');
              localStorage.removeItem(STORAGE_KEY);
          }
      } catch (error) {
          if(!auto) {
              btn.textContent = 'Ingresar';
              btn.disabled = false;
              msg.innerHTML = 'Error de conexión';
              msg.classList.add('err');
          }
      }
    }

    const smartInput = $('smartInput');
    smartInput.addEventListener('paste', (e) => {
        const pasteData = (e.clipboardData || window.clipboardData).getData('text');
        const lines = pasteData.split(/\r?\n/).map(l => l.trim()).filter(l => l);
        if (lines.length >= 3) {
            e.preventDefault();
            activateAppMode(); switchView('view-venta');
            if(lines.length>0) $('v_nombre').value = lines[0];
            if(lines.length>1) $('v_apellido').value = lines[1];
            if(lines.length>2) $('v_ciudad').value = lines[2];
            if(lines.length>3) {
                const nums = lines[3].split(',').map(n=>n.replace(/\D+/g,'')).filter(n=>n);
                numList.innerHTML=''; nums.forEach(n=>numList.appendChild(makeNumPill(n))); if(!nums.length) addDefaultPill();
            }
            if(lines.length>4) $('v_telefono').value = lines[4];
            showModal('Pegado Exitoso', 'Datos distribuidos en el formulario.'); smartInput.value = '';
        }
    });

    smartInput.onkeydown = (e)=>{ if(e.key==='Enter') runSearch(); };
    $('btnSearch').onclick = runSearch;
    function switchView(id){ document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('active')); $(id).classList.add('active'); }

    async function preprocessBlobToCanvas(blob){
      return new Promise((resolve)=>{
        const img = new Image(); img.onload = ()=>{
          const w = img.naturalWidth || img.width, h = img.naturalHeight || img.height;
          const scale = Math.min(1.5, 1200 / Math.max(w,h));
          const W = Math.round(w*scale), H = Math.round(h*scale);
          const cv = document.createElement('canvas'); cv.width = W; cv.height = H;
          const ctx = cv.getContext('2d'); ctx.drawImage(img, 0, 0, W, H); resolve(cv);
        }; img.onerror = ()=> resolve(null); img.src = URL.createObjectURL(blob);
      });
    }
    function extractRefFromText(txt){ return (txt.toUpperCase().match(/[A-Z0-9]{6,24}/g) || [])[0] || ''; }

    async function handleOCR(e, statusId, inputId) {
        var items = (e.clipboardData && e.clipboardData.items) ? e.clipboardData.items : [];
        for(var i=0; i<items.length; i++){ 
            var it = items[i];
            if(it.type && it.type.indexOf('image/') === 0){ 
                document.getElementById(statusId).innerHTML = 'Procesando imagen...';
                var f = it.getAsFile(); 
                var pre = await preprocessBlobToCanvas(f);
                var res = await Tesseract.recognize(pre || f, 'spa+eng');
                var ref = extractRefFromText(res.data.text);
                if(ref) { 
                    document.getElementById(statusId).innerHTML = "Extraído: " + ref; 
                    document.getElementById(inputId).value = ref; 
                } else { 
                    document.getElementById(statusId).innerHTML = 'Lectura fallida. Ingresa manual.'; 
                }
            }
        }
    }

    if ($('ocrDrop')) $('ocrDrop').addEventListener('paste', async (e)=>{ handleOCR(e, 'ocrStatus', 'v_referenciaAbono'); });
    if ($('ocrDropAbono')) $('ocrDropAbono').addEventListener('paste', async (e)=>{ handleOCR(e, 'ocrStatusAbono', 'a_ref'); });

    function seleccionarTransferencia(refId, montoId, metodoId, feedbackId, refVal, montoVal, metodoVal) {
        var refInput = document.getElementById(refId); var montoInput = document.getElementById(montoId); var metodoInput = document.getElementById(metodoId);
        refInput.value = refVal; montoInput.value = montoVal; metodoInput.value = metodoVal;
        refInput.readOnly = true; montoInput.readOnly = true; metodoInput.readOnly = true;
        refInput.style.backgroundColor = "var(--bg)"; montoInput.style.backgroundColor = "var(--bg)"; metodoInput.style.backgroundColor = "var(--bg)";
        document.getElementById(feedbackId).innerHTML = '<span style="color:var(--accent-hover); font-size:0.85rem; font-weight:500;">Pago vinculado.</span> <span style="color:var(--danger); cursor:pointer; font-size:0.8rem; text-decoration:underline; margin-left:8px;" onclick="desbloquearCampos(\'' + refId + '\', \'' + montoId + '\', \'' + metodoId + '\', \'' + feedbackId + '\')">Desvincular</span>';
    }

    function desbloquearCampos(refId, montoId, metodoId, feedbackId) {
        var refInput = document.getElementById(refId); var montoInput = document.getElementById(montoId); var metodoInput = document.getElementById(metodoId);
        refInput.readOnly = false; montoInput.readOnly = false; metodoInput.readOnly = false;
        refInput.value = ""; montoInput.value = ""; metodoInput.value = "";
        refInput.style.backgroundColor = "transparent"; montoInput.style.backgroundColor = "transparent"; metodoInput.style.backgroundColor = "transparent";
        if(feedbackId) document.getElementById(feedbackId).innerHTML = '<span style="color:var(--muted); font-size:0.8rem;">Desvinculado.</span>';
    }

    async function buscarTransferenciasUI(btnId, fechaId, montoIdFiltro, refIdFiltro, feedbackId, targetRefId, targetMontoId, targetMetodoId) {
        var fechaVal = document.getElementById(fechaId).value; 
        var montoVal = document.getElementById(montoIdFiltro).value;
        var refVal = document.getElementById(refIdFiltro).value;
        var fb = document.getElementById(feedbackId);
        var btn = document.getElementById(btnId);

        if(!fechaVal && !montoVal && !refVal) { fb.innerHTML = "<span class='hint err'>Ingresa un filtro.</span>"; return; }

        var originalTxt = btn.textContent;
        btn.textContent = "Buscando..."; btn.disabled = true; fb.innerHTML = "";

        var payload = { fecha: fechaVal, monto: montoVal, referencia: refVal };

        try {
            const req = await fetch('/api/admin/transferencias', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const res = await req.json();
            btn.textContent = originalTxt; btn.disabled = false;

            if(res.status === 'ok') {
                if(res.lista.length === 0) {
                    fb.innerHTML = "<span class='hint err'>Sin resultados.</span>";
                } else {
                    var html = '<div style="display:flex; flex-direction:column; gap:8px; margin-top:12px;">';
                    for(var i=0; i<res.lista.length; i++){
                        var t = res.lista[i];
                        var montoFmt = new Intl.NumberFormat('es-CO').format(t.monto);
                        var refSafe = t.referencia.replace(/'/g, "\\'"); var platSafe = t.plataforma.replace(/'/g, "\\'");
                        
                        var badgeClass = t.status === 'LIBRE' ? 'success' : 'danger';
                        
                        html += '<div onclick="seleccionarTransferencia(\'' + targetRefId + '\', \'' + targetMontoId + '\', \'' + targetMetodoId + '\', \'' + feedbackId + '\', \'' + refSafe + '\', ' + t.monto + ', \'' + platSafe + '\')"';
                        html += ' style="border:1px solid var(--border); padding:12px; border-radius:8px; cursor:pointer; background:var(--card); transition:all 0.2s;"';
                        html += ' onmouseover="this.style.borderColor=\'var(--accent)\'" onmouseout="this.style.borderColor=\'var(--border)\'">';
                        html += '<div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span style="font-weight:600; font-size:0.9rem; color:var(--ink);">' + t.plataforma + '</span><span style="font-weight:600; font-size:0.9rem;">$' + montoFmt + '</span></div>';
                        html += '<div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-size:0.8rem; color:var(--muted);">Ref: ' + t.referencia + ' &bull; ' + t.fecha + '</span>';
                        html += '<span class="badge ' + badgeClass + '">' + (t.status || 'LIBRE') + '</span></div>';
                        html += '</div>';
                    }
                    html += '</div>';
                    fb.innerHTML = html;
                }
            } else {
                fb.innerHTML = "<span class='hint err'>" + res.mensaje + "</span>";
            }
        } catch(e) {
            btn.textContent = originalTxt; btn.disabled = false;
            fb.innerHTML = "<span class='hint err'>Error de conexión.</span>";
        }
    }

    let esVentaPendiente = false; let esAbonoPendiente = false;
    $('btnForzarPendiente').onclick = ()=>{ if(!$('v_referenciaAbono').value) return alert('Ingresa una referencia'); esVentaPendiente=true; $('btnForzarPendiente').style.background='var(--ink)'; $('btnForzarPendiente').style.color='#fff'; };
    $('btnForzarPendienteAbono').onclick = ()=>{ if(!$('a_ref').value) return alert('Ingresa una referencia'); esAbonoPendiente=true; $('btnForzarPendienteAbono').style.background='var(--ink)'; $('btnForzarPendienteAbono').style.color='#fff'; };

    async function runSearch(){
      const q = smartInput.value.trim(); if(!q) return;
      feedback.textContent = "Buscando...";
      try {
        const response = await fetch('/api/admin/buscar?q=' + encodeURIComponent(q));
        const res = await response.json();
        feedback.textContent = "";
        if(res.tipo === 'ERROR_SERVIDOR') return showModal('Error', res.mensaje);
        if(res.tipo !== 'NO_EXISTE') activateAppMode();
        if(res.tipo==='BOLETA_DISPONIBLE'){ switchView('view-venta'); numList.innerHTML=''; numList.appendChild(makeNumPill(res.data.numero)); $('v_nombre').focus(); } 
        else if(res.tipo==='BOLETA_OCUPADA'){ switchView('view-cliente'); renderClienteInfo([res.data.infoVenta]); } 
        else if(res.tipo==='CLIENTE_ENCONTRADO'){ switchView('view-cliente'); renderClienteInfo(res.lista); } 
        else { showModal('Aviso', res.mensaje || 'Intenta de nuevo'); }
      } catch (err) { feedback.textContent = ""; showModal('Error', err.message); }
    }

    $('btnRegistrarVenta').onclick = async ()=>{
       const nums = Array.from(numList.querySelectorAll('input')).map(i=>i.value).filter(v=>v.length===4);
       if(!nums.length) return alert('Número de boleta inválido');
       $('btnRegistrarVenta').textContent='Procesando...'; $('btnRegistrarVenta').disabled=true;
       
       let totalMoney=0, ref='', metodo='';
       if (modoVenta === 'separar') { totalMoney=0; ref='0'; metodo='Separado'; } 
       else { totalMoney=Number($('v_primerAbono').value)||0; ref=$('v_referenciaAbono').value; metodo=$('v_metodoPago').value; }

       const perNum = Math.floor(totalMoney/nums.length);
       const baseData = { nombre:$('v_nombre').value, apellido:$('v_apellido').value, ciudad:$('v_ciudad').value, telefono:$('v_telefono').value, primerAbono:perNum, referenciaAbono: ref, metodoPago: metodo, esPendiente:esVentaPendiente, contrasena:localStorage.getItem(STORAGE_KEY) };
       
       let ok=0, fails=0;
       let detalleErrores = []; 

       for (let i=0; i < nums.length; i++) {
           try {
               const req = await fetch('/api/admin/venta', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({...baseData, numeroBoleta: nums[i]}) });
               const res = await req.json();
               if(res.status === 'ok') {
                   ok++; 
               } else {
                   fails++;
                   detalleErrores.push(`Boleta ${nums[i]}: ${res.mensaje}`); 
               }
           } catch(e) { 
               fails++; 
               detalleErrores.push(`Boleta ${nums[i]}: Error de conexión`);
           }
       }
       
       $('btnRegistrarVenta').textContent = modoVenta === 'separar' ? 'Confirmar Separado ($0)' : 'Registrar Venta'; 
       $('btnRegistrarVenta').disabled=false;
       
       let mensajeFinal = `Completadas: ${ok} \nErrores: ${fails}`;
       if (fails > 0) {
           mensajeFinal += `\n\nDetalles:\n` + detalleErrores.join('\n');
       }
       
       $('mMsg').style.whiteSpace = 'pre-line'; 
       showModal('Resumen de Operación', mensajeFinal);
       
       if(fails===0){ 
           $('v_nombre').value=''; $('v_apellido').value=''; $('v_telefono').value=''; $('v_ciudad').value=''; $('v_primerAbono').value=0; $('v_referenciaAbono').value=''; $('v_metodoPago').value='';
           desbloquearCampos('v_referenciaAbono', 'v_primerAbono', 'v_metodoPago', 'feedbackTransfer');
           esVentaPendiente=false; $('btnForzarPendiente').style.background=''; $('btnForzarPendiente').style.color='';
           numList.innerHTML=''; addDefaultPill(); activateHeroMode();
       }
    };

    async function registrarAbono() {
        const btn = document.getElementById('btnRegistrarAbono');
        const checkboxes = document.querySelectorAll('.boleta-pay-checkbox:checked');
        const boletasTarget = Array.from(checkboxes).map(c => c.value);
        if(boletasTarget.length === 0) return alert("Selecciona boletas.");
        const montoTotal = Number($('a_monto').value); const ref = $('a_ref').value; const metodo = $('a_metodo').value;
        if(montoTotal <= 0) return alert("Monto inválido.");
        
        const montoPorBoleta = Math.floor(montoTotal / boletasTarget.length);
        const textoOriginal = btn.textContent; btn.textContent = 'Procesando...'; btn.disabled = true;

        const basePayload = { metodoPago: metodo, referencia: ref || 'efectivo', esPendiente: esAbonoPendiente, contrasena: localStorage.getItem(STORAGE_KEY) };
        let ok = 0; let fails = 0;

        for (let i=0; i < boletasTarget.length; i++) {
            try {
               const req = await fetch('/api/admin/abono', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ ...basePayload, numeroBoleta: boletasTarget[i], valorAbono: montoPorBoleta }) });
               const res = await req.json();
               if(res.status === 'ok') ok++; else fails++;
            } catch(e) { fails++; }
        }
        btn.textContent = textoOriginal; btn.disabled = false;
        if (fails === 0) {
            showModal('Completado', `Abono distribuido correctamente.`);
            $('a_monto').value = ''; $('a_ref').value = ''; $('a_metodo').value = '';
            desbloquearCampos('a_ref', 'a_monto', 'a_metodo', 'feedbackTransferAbono');
            esAbonoPendiente=false; $('btnForzarPendienteAbono').style.background=''; $('btnForzarPendienteAbono').style.color='';
            runSearch(); 
        } else { showModal('Aviso', `Éxito: ${ok}, Fallos: ${fails}.`); }
    }

    function renderClienteInfo(lista){
       var c = lista[0]; var totalAbonadoGlobal = 0; var totalRestanteGlobal = 0; var boletasStr = [];
       var checkboxContainer = document.getElementById('boletas-checkbox-container'); if(checkboxContainer) checkboxContainer.innerHTML = '';
       var fmt = function(n) { return new Intl.NumberFormat('es-CO').format(n); };

       var html = '<div style="padding:24px; border-bottom:1px solid var(--border);">';
       
       for(var i=0; i<lista.length; i++){
           var b = lista[i]; var restante = Number(b.restante) || 0;
           totalAbonadoGlobal += (Number(b.totalAbonos) || 0); totalRestanteGlobal += restante;
           boletasStr.push(b.numero);
           
           if(checkboxContainer) {
               var label = document.createElement('label'); label.style.cssText = "display:flex; align-items:center; gap:12px; background:var(--bg); padding:10px 16px; border-radius:var(--radius); border:1px solid var(--border); cursor:pointer; font-size:0.9rem; width:100%; transition:border 0.2s;";
               var chk = document.createElement('input'); chk.type = 'checkbox'; chk.value = b.numero; chk.className = 'boleta-pay-checkbox'; chk.checked = true;
               var span = document.createElement('span'); span.innerHTML = '<span style="font-weight:600; color:var(--ink);">' + b.numero + '</span> <span style="color:var(--muted); font-size:0.8rem; margin-left:4px;">(Resta $' + fmt(restante) + ')</span>';
               
               var btnLiberar = document.createElement('button');
               btnLiberar.type = 'button';
               btnLiberar.innerHTML = 'Liberar';
               btnLiberar.style.cssText = "margin-left:auto; background:transparent; color:var(--danger); border:1px solid var(--danger); padding:4px 12px; border-radius:6px; font-size:0.75rem; font-weight:500; cursor:pointer; transition:all 0.2s;";
               btnLiberar.onmouseover = function() { this.style.background = 'var(--danger-bg)'; };
               btnLiberar.onmouseout = function() { this.style.background = 'transparent'; };
               btnLiberar.onclick = function(e) { e.preventDefault(); e.stopPropagation(); confirmarLiberarBoleta(b.numero); };

               label.appendChild(chk); label.appendChild(span); label.appendChild(btnLiberar); checkboxContainer.appendChild(label);
           }
       }

       html += '<div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:16px;">';
       html += '  <div><div style="font-size:0.7rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:2px;">Números</div><div style="font-weight:600; color:var(--ink); font-size:1.1rem;">' + boletasStr.join(', ') + '</div></div>';
       html += '  <div style="text-align:right;"><div style="font-size:0.7rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:2px;">Teléfono</div><div style="font-weight:500; color:var(--ink); font-size:1rem;">' + c.telefono + '</div></div>';
       html += '</div>';
       
       html += '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">';
       html += '  <input type="text" style="background:var(--bg); border:1px solid var(--border); padding:10px 12px; border-radius:var(--radius); width:100%; font-size:0.9rem; color:var(--ink-2); outline:none;" value="' + c.nombre + '" readonly>';
       html += '  <input type="text" style="background:var(--bg); border:1px solid var(--border); padding:10px 12px; border-radius:var(--radius); width:100%; font-size:0.9rem; color:var(--ink-2); outline:none;" value="' + c.apellido + '" readonly>';
       html += '</div>';
       html += '<input type="text" style="background:var(--bg); border:1px solid var(--border); padding:10px 12px; border-radius:var(--radius); width:100%; font-size:0.9rem; color:var(--ink-2); outline:none; margin-bottom:16px;" value="' + c.ciudad + '" readonly>';

       html += '<div style="display:flex; justify-content:space-between; align-items:center; background:var(--bg); border-radius:var(--radius); padding:12px 16px;">';
       html += '  <div style="display:flex; gap:16px; align-items:center;">';
       html += '    <div><span style="font-size:0.7rem; color:var(--muted); display:block; margin-bottom:2px;">ABONADO</span><span style="font-size:1rem; font-weight:600; color:var(--ink);">$' + fmt(totalAbonadoGlobal) + '</span></div>';
       html += '    <div style="height:24px; width:1px; background:var(--border);"></div>'; 
       html += '    <div><span style="font-size:0.7rem; color:var(--muted); display:block; margin-bottom:2px;">PENDIENTE</span><span style="font-size:1rem; font-weight:600; color:var(--danger);">$' + fmt(totalRestanteGlobal) + '</span></div>';
       html += '  </div>';
       html += '  <button id="btnCopiar" style="background:#fff; border:1px solid var(--border); color:var(--ink); padding:6px 12px; border-radius:6px; font-weight:500; cursor:pointer; font-size:0.8rem; transition:background 0.2s;">Copiar Link</button>';
       html += '</div></div>';

       html += '<div style="padding:24px; background:var(--bg);">';
       html += '  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">';
       html += '    <div style="font-weight: 600; color: var(--ink); font-size: 0.95rem;">Historial de Pagos</div>';
       html += '    <select id="boletaSelector" style="background:#fff; border:1px solid var(--border); border-radius:6px; padding:4px 8px; font-size:0.8rem; color:var(--ink-2); outline:none;" onchange="cargarHistorialAbonos(this.value)">';
       for(var i=0; i<boletasStr.length; i++) { html += '<option value="'+boletasStr[i]+'">Boleta '+boletasStr[i]+'</option>'; }
       html += '    </select>';
       html += '  </div>';
       html += '  <div id="historial-abonos-render"><p style="text-align:center; color:var(--muted); font-size:0.85rem; margin:0;">Cargando...</p></div>';
       html += '</div>';
       
       document.getElementById('cliente-info-render').innerHTML = html;

       document.getElementById('btnCopiar').addEventListener('click', async function() {
           var links = lista.map(b => window.location.origin + '/boleta/' + b.numero).join('\n');
           try { await navigator.clipboard.writeText(links); 
             var oldText = this.textContent; this.textContent = '¡Copiado!'; this.style.background = 'var(--accent-bg)'; this.style.color = 'var(--accent-hover)'; this.style.borderColor = 'var(--accent-bg)';
             setTimeout(()=>{ this.textContent=oldText; this.style.background='#fff'; this.style.color='var(--ink)'; this.style.borderColor='var(--border)'; }, 2000);
           } catch(e){}
       });

       if(boletasStr.length > 0) cargarHistorialAbonos(boletasStr[0]);
    }

    async function cargarHistorialAbonos(numero) {
        const div = $('historial-abonos-render');
        div.innerHTML = '<p style="text-align:center; color:var(--muted); font-size:0.85rem;">Cargando historial...</p>';
        try {
            const req = await fetch('/api/admin/historial?numero=' + numero);
            const res = await req.json();
            if(res.status === 'ok') renderTablaAbonos(res.lista);
            else div.innerHTML = `<p style="text-align:center; color:var(--danger);">${res.mensaje}</p>`;
        } catch(e) { div.innerHTML = '<p style="text-align:center; color:var(--danger);">Error cargando historial.</p>'; }
    }

    function renderTablaAbonos(lista) {
        const div = $('historial-abonos-render');
        if(!lista || lista.length === 0) {
            div.innerHTML = '<div style="text-align:center; padding:20px; border:1px dashed var(--border); border-radius:8px;"><p style="color:var(--muted); font-size:0.85rem; margin:0;">Sin abonos registrados.</p></div>';
            return;
        }

        let html = '<div style="overflow-x:auto; background:#fff; border:1px solid var(--border); border-radius:8px;"><table style="width:100%; border-collapse:collapse; font-size:0.85rem; text-align:left;">';
        html += '<thead><tr style="border-bottom:1px solid var(--border); background:var(--bg); color:var(--ink-2);"><th style="padding:10px 12px; font-weight:500;">Fecha</th><th style="padding:10px 12px; font-weight:500;">Monto</th><th style="padding:10px 12px; font-weight:500;">Ref</th><th style="padding:10px 12px; text-align:right;"></th></tr></thead><tbody>';
        
        lista.forEach(a => {
            const valFmt = new Intl.NumberFormat('es-CO', {style:'currency', currency:'COP', minimumFractionDigits:0}).format(a.monto);
            const fechaLimpia = new Date(a.fecha_pago).toLocaleDateString('es-CO');
            
            html += `<tr style="border-bottom:1px solid var(--border);">
                        <td style="padding:12px; color:var(--ink-2);">${fechaLimpia}</td>
                        <td style="padding:12px; font-weight:600; color:var(--ink);">${valFmt}</td>
                        <td style="padding:12px; color:var(--muted); font-size:0.8rem; word-break:break-all;">${a.referencia_transferencia || '-'}</td>
                        <td style="padding:12px; text-align:right;">
                            <button style="background:transparent; border:none; color:var(--muted); font-size:1.1rem; cursor:pointer; padding:0 4px; transition:color 0.2s;" onmouseover="this.style.color='var(--danger)'" onmouseout="this.style.color='var(--muted)'" title="Eliminar" onclick="confirmarEliminarAbono('${a.id}', this)">&times;</button>
                        </td>
                    </tr>`;
        });
        html += '</tbody></table></div>';
        div.innerHTML = html;
    }

    async function confirmarEliminarAbono(idAbono, btnElement) {
        if(!confirm("¿Eliminar este abono definitivamente? Las transferencias vinculadas se liberarán.")) return;
        
        btnElement.innerHTML = '...'; btnElement.disabled = true;
        
        try {
            const req = await fetch('/api/admin/eliminar-abono', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: idAbono, contrasena: localStorage.getItem(STORAGE_KEY) })
            });
            const res = await req.json();
            
            if(res.status === 'ok') { runSearch(); } 
            else { showModal('Error', res.mensaje); btnElement.innerHTML = '&times;'; btnElement.disabled = false; }
        } catch(e) {
            showModal('Error', 'Error de conexión.'); btnElement.innerHTML = '&times;'; btnElement.disabled = false;
        }
    }

    async function confirmarLiberarBoleta(numero) {
        if(!confirm(`ATENCIÓN: ¿Liberar boleta ${numero}?\n\nSe borrará su historial de pagos y quedará disponible para nueva venta. Esta acción es irreversible.`)) return;
        
        try {
            const req = await fetch('/api/admin/liberar-boleta', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ numeroBoleta: numero, contrasena: localStorage.getItem(STORAGE_KEY) })
            });
            const res = await req.json();
            
            if(res.status === 'ok') {
                showModal('Operación Exitosa', res.mensaje);
                activateHeroMode(); 
            } else { showModal('Error', res.mensaje); }
        } catch(e) { showModal('Error', 'Error de conexión.'); }
    }
    
    async function procesarCSVBancos() {
        const fileInput = document.getElementById('fileBancos');
        if (!fileInput.files.length) return alert("Selecciona un archivo CSV.");
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        const btn = document.getElementById('btnProcesarBancos');
        const txtOriginal = btn.textContent;
        btn.textContent = 'Procesando...'; btn.disabled = true;

        reader.onload = async function(e) {
            const text = e.target.result; const rows = text.split('\n'); const transferenciasNuevas = [];

            for(let i = 0; i < rows.length; i++) {
                const row = rows[i].trim(); if(!row) continue;
                const cols = row.split(','); if(cols.length < 12) continue; 
                
                let monto = parseFloat(cols[9]) || 0;
                let fechaRaw = cols[1]; 
                let fechaFormateada = new Date().toISOString(); 
                if(fechaRaw && fechaRaw.length === 8) {
                    fechaFormateada = `${fechaRaw.slice(4,8)}-${fechaRaw.slice(2,4)}-${fechaRaw.slice(0,2)}T00:00:00.000Z`;
                }
                let descripcion = cols[4] || "";
                let plataforma = descripcion.includes("NEQUI") ? "Nequi" : "Bancolombia";
                let referencia = (cols[11] || "").replace(/"/g, ''); 

                transferenciasNuevas.push({ monto: monto, fecha_pago: fechaFormateada, plataforma: plataforma, referencia: referencia, estado: 'LIBRE' });
            }

            if(transferenciasNuevas.length === 0) {
                btn.textContent = txtOriginal; btn.disabled = false;
                return alert("No hay transferencias válidas.");
            }

            try {
                const req = await fetch('/api/admin/subir-bancos', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ transferencias: transferenciasNuevas, contrasena: localStorage.getItem(STORAGE_KEY) })
                });
                const res = await req.json();
                btn.textContent = txtOriginal; btn.disabled = false;

                if(res.status === 'ok') { showModal('Procesado', res.mensaje); fileInput.value = ""; } 
                else { showModal('Error', res.mensaje); }
            } catch(error) {
                btn.textContent = txtOriginal; btn.disabled = false;
                showModal('Error', 'Error de servidor.');
            }
        };
        reader.readAsText(file);
    }

    function showModal(title,msg){ $('mTitle').textContent=title; $('mMsg').textContent=msg; $('modalResult').style.display='flex'; }
    $('mBtn').onclick = function(){ $('modalResult').style.display='none'; };
    document.addEventListener('DOMContentLoaded', function() { initLogin(); if(typeof addDefaultPill === 'function') addDefaultPill(); $('loginPwd').addEventListener('keyup', function(e) { if (e.key === 'Enter') verifyLogin(this.value); }); });
  </script>
</body>
</html>
