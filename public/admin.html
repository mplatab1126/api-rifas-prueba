<!DOCTYPE html>
<html lang="es">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>Admin Los Plata</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* --- DISE√ëO MINIMALISTA Y PASTEL --- */
    :root{
      --ink: #2b3a35; 
      --ink-2: #52665e; 
      --muted: #8ba89d; 
      --bg: #f7fcf9; 
      --card: #ffffff;
      --ring: #e6eee9; 
      --ring-strong: #d1e3da; 
      --pill: #f0f7f3; 
      --accent: #4eb082; 
      --accent-2: #3a946a;
      --danger: #d95a53; 
      --danger-bg: #fcf2f2; 
      --shadow: 0 4px 12px rgba(0,0,0,.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; 
      background: var(--bg);
      font-family: 'Poppins', system-ui, -apple-system, sans-serif; 
      color: var(--ink); 
      padding-bottom: 80px;
    }
    
    .shell { max-width: 550px; margin: 20px auto; padding: 0 18px; display: none; opacity: 0; transition: opacity 0.4s ease; }
    .shell.visible { display: block; opacity: 1; }
    
    .top-search-bar { position: sticky; top: 0; z-index: 100; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(5px); border-bottom: 1px solid var(--ring); padding: 12px 16px; box-shadow: var(--shadow); margin-bottom: 20px; transition: all 0.5s ease; transform: translateY(0); }
    .top-search-bar.hero-mode { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 600px; background: transparent; border-bottom: none; box-shadow: none; padding: 0; z-index: 1000; }
    
    .search-container { max-width: 550px; margin: 0 auto; display: flex; gap: 8px; transition: all 0.3s ease; }
    .main-input { width: 100%; border: 1px solid var(--ring-strong); border-radius: 12px; padding: 12px 16px; font-size: 0.95rem; outline: none; transition: all 0.2s ease; background: #fff; color: var(--ink); font-weight: 500; }
    .main-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(78, 176, 130, 0.1); }
    .hero-mode .main-input { padding: 20px 24px; font-size: 1.05rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); border-color: transparent; text-align: center; }
    
    .search-btn { background: var(--accent); color: #fff; border: none; border-radius: 12px; padding: 0 20px; font-weight: 600; cursor: pointer; font-size: 0.95rem; transition: all 0.2s ease; }
    .search-btn:hover { background: var(--accent-2); }
    .hero-mode .search-btn { display: none; }
    
    .hero-welcome-text { text-align: center; margin-bottom: 20px; opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.4s ease; position: absolute; top: -100px; left: 0; right: 0; }
    .hero-mode .hero-welcome-text { opacity: 1; visibility: visible; transform: translateY(0); position: relative; top: auto; }
    
    .user-info-bar { text-align: center; margin-top: 8px; font-size: 0.8rem; transition: all 0.4s ease; color: var(--muted); }
    .hero-mode .user-info-bar { 
    position: relative; 
    top: auto; 
    right: auto; 
    margin: 24px auto 0 auto; 
    background: rgba(255,255,255,0.9); 
    padding: 8px 24px; 
    border-radius: 50px; 
    border: 1px solid var(--ring); 
    box-shadow: var(--shadow); 
    width: max-content; 
}
    
    .section-card { background: #fff; border: 1px solid var(--ring); border-radius: 16px; box-shadow: var(--shadow); padding: 24px; margin-bottom: 20px; }
    .section-title { font-size: 1.05rem; font-weight: 600; color: var(--ink); margin: 0 0 16px 0; padding-bottom: 10px; border-bottom: 1px solid var(--ring); display: flex; align-items: center; justify-content: space-between; }
    
    .vertical-form { display: flex; flex-direction: column; gap: 14px; }
    label { display: block; font-weight: 500; color: var(--ink-2); margin: 0 0 6px; font-size: 0.85rem; }
    
    .field { display: flex; align-items: center; gap: 8px; background: #fff; border: 1px solid var(--ring-strong); border-radius: 10px; padding: 10px 12px; transition: border-color .2s; }
    .field:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(78, 176, 130, 0.1); }
    .pill { flex: 1; border: 0; outline: 0; font-size: 0.95rem; background: transparent; color: var(--ink); width: 100%; font-family: inherit;}
    
    .num-wrap { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .num-pill { background: var(--pill); border: 1px solid var(--ring-strong); border-radius: 10px; padding: 6px 10px; display: flex; gap: 8px; align-items: center; width: fit-content; }
    .num-pill input { width: 50px; border: 0; outline: 0; background: transparent; font-size: 1rem; font-weight: 600; color: var(--ink); text-align: center; font-family: inherit;}
    .chip-del { border: none; background: transparent; color: var(--muted); font-weight: 500; border-radius: 6px; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;}
    .chip-del:hover { background: var(--danger-bg); color: var(--danger); }
    .btn-add { border: 1px dashed var(--accent); background: transparent; color: var(--accent-2); border-radius: 8px; padding: 6px 12px; font-weight: 500; font-size: 0.8rem; cursor: pointer; transition: all .2s; }
    .btn-add:hover { background: var(--pill); }

    .cta { display: block; width: 100%; border: none; border-radius: 10px; padding: 12px; font-weight: 600; font-size: 0.95rem; background: var(--accent); color: #fff; cursor: pointer; text-align: center; margin-top: 8px; transition: background 0.2s; font-family: inherit;}
    .cta:hover { background: var(--accent-2); }
    .cta:active { transform: scale(0.99); }

    .modal-overlay { position: fixed; inset: 0; background: rgba(247, 252, 249, 0.8); backdrop-filter: blur(4px); z-index: 2000; display: none; align-items: center; justify-content: center; }
    .modal-card { background: #fff; width: 90%; max-width: 360px; border-radius: 20px; padding: 30px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.08); border: 1px solid var(--ring); }
    #loginOverlay { background: var(--bg); z-index: 10000; display: flex; } 
    .hint { margin-top: 10px; text-align: center; font-weight: 500; color: var(--muted); font-size: 0.85rem; }
    .hint.err { color: var(--danger); }
    
    .mode-switch { display: flex; background: #fff; border-radius: 12px; padding: 4px; margin-bottom: 20px; border: 1px solid var(--ring); box-shadow: var(--shadow); }
    .mode-btn { flex: 1; border: none; background: transparent; padding: 10px; border-radius: 8px; font-weight: 500; color: var(--muted); cursor: pointer; transition: all 0.2s; font-size: 0.9rem; font-family: inherit;}
    .mode-btn.active { background: var(--pill); color: var(--accent-2); border: 1px solid var(--ring-strong); font-weight: 600; }
    
    .ocr-drop { border: 1px dashed var(--ring-strong); background: var(--bg); border-radius: 12px; padding: 16px; text-align: center; font-weight: 500; color: var(--muted); cursor: pointer; margin-bottom: 4px; font-size: 0.85rem; transition: 0.2s; }
    .ocr-drop:hover { border-color: var(--accent); background: var(--pill); color: var(--ink-2); }

    .view-section { display: none; animation: fadeIn 0.3s ease; }
    .view-section.active { display: block; }
    @keyframes fadeIn{from{opacity:0} to{opacity:1}}
    /* ================================================== */
    /* DISE√ëO RESPONSIVE (ADAPTACI√ìN A CELULARES Y PC)    */
    /* ================================================== */

    /* 1. Ajustar el contenedor principal para que use mejor el espacio en PC */
    .shell, .search-container { max-width: 700px; }

    /* 2. Arreglar el men√∫ de navegaci√≥n para que haga saltos de l√≠nea en celulares */
    .user-info-bar { 
        display: flex; 
        flex-wrap: wrap; 
        justify-content: center; 
        gap: 12px; 
        line-height: 1.5;
    }
    .user-info-bar span { margin-right: 0 !important; }
    .hero-mode .user-info-bar { max-width: 90%; }

    /* 3. REGLAS ESPECIALES SOLO PARA CELULARES (Pantallas menores a 650px) */
    @media (max-width: 650px) {
        /* Evitar que los formularios de 3 columnas (Ref, Valor, Banco) se aplasten: los apila hacia abajo */
        div[style*="display: flex; gap: 10px;"] {
            flex-direction: column !important;
        }
        
        /* Ajustar los campos divididos en 2 columnas (Nombre, Apellido, Ciudad) */
        div[style*="display:grid; grid-template-columns: 1fr 1fr;"] {
            grid-template-columns: 1fr !important;
        }

        /* Hacer que las letras de las tablas se achiquen un poco para que quepan completas */
        table { font-size: 0.75rem !important; }
        th, td { padding: 8px 4px !important; }
        
        /* Ajustar las ventanas emergentes (modales) para que no toquen los bordes del celular */
        .modal-card { width: 92%; padding: 20px; }
    }
  </style>
</head>
<body>

  <div id="loginOverlay" class="modal-overlay">
    <div class="modal-card">
      <h2 style="margin: 0 0 8px; color: var(--ink); font-weight: 600; font-size: 1.4rem;">Acceso</h2>
      <p style="color:var(--muted); font-size: 0.9rem; margin-bottom: 20px;">Ingresa tu clave de administrador</p>
      <div class="field" style="margin-bottom:20px;">
        <input id="loginPwd" type="password" class="pill" placeholder="Contrase√±a..." style="text-align:center">
      </div>
      <button id="btnLogin" class="cta">Ingresar</button>
      <div id="loginMsg" class="hint"></div>
    </div>
  </div>

  <div class="top-search-bar hero-mode" id="topBar" style="display:none">
    <div class="hero-welcome-text">
        <h1 style="color:var(--ink); margin:0; font-size: 1.8rem; font-weight: 600;">LOS PLATA S.A.S.</h1>
        <p style="color:var(--muted); font-size: 0.95rem; margin: 6px 0 0 0;">Busca boleta, tel√©fono o pega datos</p>
    </div>
    <div class="search-container">
      <input type="text" id="smartInput" class="main-input" placeholder="Escribe para buscar o pegar..." autocomplete="off">
      <button id="btnSearch" class="search-btn">Buscar</button>
    </div>
    <div class="user-info-bar">
      <span id="asesorDisplay" style="font-weight:600; color:var(--ink); margin-right:12px;">Hola</span>
      <span style="cursor:pointer; color:var(--accent-2); margin-right:12px; font-weight:500;" onclick="activateAppMode(); switchView('view-referencias')">Referencia</span>
      <span style="cursor:pointer; color:var(--accent-2); margin-right:12px; font-weight:500;" onclick="activateAppMode(); switchView('view-bancos')">Subir transferencias</span>
      <span style="cursor:pointer; color:var(--accent-2); margin-right:12px; font-weight:500;" onclick="activateAppMode(); switchView('view-estadisticas'); cargarEstadisticas();">üìà Rendimiento</span>
      <span style="cursor:pointer; color:var(--accent-2); margin-right:12px; font-weight:500;" onclick="activateAppMode(); switchView('view-movimientos'); cargarUltimosMovimientos();">√öltimos Movimientos</span>
      <span id="btnLogout" style="cursor:pointer; color:var(--muted); font-weight:500;">Salir</span>
    </div>
    <div id="searchFeedback" class="hint" style="margin: 5px 0 0 0; font-size:0.8rem; min-height: 20px;"></div>
  </div>

  <div class="shell" id="appShell">

    <div id="view-referencias" class="view-section">
      <div class="section-card">
        <div class="section-title">Buscar Referencia Espec√≠fica</div>
        <p style="font-size: 0.85rem; color: var(--muted); margin-top: 0;">Ingresa el n√∫mero de referencia exacto para ver su estado actual y la boleta vinculada.</p>
        
        <div class="vertical-form">
          <div class="field" style="background:var(--bg);">
            <input type="text" id="inputBuscarRef" class="pill" placeholder="Escribe la referencia... (Ej: M093...)">
          </div>
          <button id="btnBuscarRef" class="cta" onclick="buscarReferenciaEspecifica()" style="margin-top:5px; background:var(--ink);">Buscar Referencia</button>
        </div>
        <div id="resultadoReferencia" style="margin-top: 20px;"></div>
      </div>
    </div>

    <div id="view-bancos" class="view-section">
      <div class="section-card">
        <div class="section-title">Cargar Extracto Bancolombia</div>
        <p style="font-size: 0.85rem; color: var(--muted); margin-top: 0;">Sube el archivo .CSV descargado de la Sucursal Virtual. El sistema extraer√° autom√°ticamente el monto, la fecha y la cuenta de origen.</p>
        
        <div class="vertical-form">
          <div class="field" style="background:var(--bg); border: 1px dashed var(--accent); padding: 20px; justify-content: center;">
            <input type="file" id="fileBancos" accept=".csv, .pdf" multiple style="font-size: 0.9rem; color: var(--ink-2);">
          </div>
          <button id="btnProcesarBancos" class="cta" onclick="procesarCSVBancos()" style="margin-top:10px;">Procesar archivo</button>
        </div>
      </div>
    </div>


    <div id="view-estadisticas" class="view-section">
      <div class="section-card">
        <div class="section-title">Rendimiento por Asesor y D√≠a</div>
        <p style="font-size: 0.85rem; color: var(--muted); margin-top: 0;">Aqu√≠ puedes ver cu√°ntas boletas nuevas separ√≥ cada asesor, cu√°ntas recibieron abono y el dinero total recaudado en el d√≠a.</p>
        
        <div id="tablaEstadisticasRender" style="margin-top: 15px;">
          <p style="text-align:center; color:var(--muted); font-size:0.85rem;">Cargando tabla de rendimiento...</p>
        </div>
      </div>
    </div>
  
    <div id="view-movimientos" class="view-section">
      <div class="section-card">
        <div class="section-title">√öltimos Movimientos Registrados</div>
        <p style="font-size: 0.85rem; color: var(--muted); margin-top: 0;">Aqu√≠ puedes revisar tus √∫ltimas ventas y abonos. Si te equivocaste en uno, presiona "Deshacer".</p>
        
        <div id="tablaMovimientosRender" style="margin-top: 15px;">
          <p style="text-align:center; color:var(--muted); font-size:0.85rem;">Cargando...</p>
        </div>
      </div>
    </div>
    
    <div id="view-venta" class="view-section">
      <div class="section-card">
        <div class="section-title"><span>Boletas a separar</span><button id="btnAddNum" class="btn-add">Agregar</button></div>
        <div id="numList" class="num-wrap"></div>
      </div>

      <div class="section-card">
        <div class="section-title">Datos del Cliente</div>
        <div class="vertical-form">
          <div><label>Nombre</label><div class="field"><input id="v_nombre" class="pill" type="text"></div></div>
          <div><label>Apellido</label><div class="field"><input id="v_apellido" class="pill" type="text"></div></div>
          <div><label>Tel√©fono celular</label><div class="field"><input id="v_telefono" class="pill" type="tel"></div></div>
          <div><label>Ciudad</label><div class="field"><input id="v_ciudad" class="pill" type="text"></div></div>
        </div>
      </div>

      <div class="mode-switch">
        <button id="btnModeAbono" class="mode-btn" onclick="setMode('abono')">Con Abono</button>
        <button id="btnModeSeparar" class="mode-btn active" onclick="setMode('separar')">Solo Separar ($0)</button>
      </div>

      <div id="paymentSections" style="display: none;">
        <div class="section-card">
          <div class="section-title">BUSCAR PAGO INTELIGENTE</div>
          <div class="vertical-form">
            <div id="ocrDrop" class="ocr-drop">
               Pega la imagen del comprobante aqu√≠ (Ctrl+V) para extraer Referencia<br>
               <span id="ocrStatus" style="color:var(--accent-2); font-weight:normal; margin-top: 4px; display: block;"></span>
            </div>

            <p style="font-size: 0.8rem; color: var(--muted); margin-top: -10px;">Llena al menos uno de estos datos para buscar en bancos:</p>
            <div style="display: flex; gap: 10px;">
              <div style="flex: 1;">
                <label>Ref/Celular</label>
                <div class="field"><input id="t_ref" class="pill" type="text" placeholder="Ej: 311..."></div>
              </div>
              <div style="flex: 1;">
                <label>Valor</label>
                <div class="field"><input id="t_monto" class="pill" type="number" placeholder="Ej: 5000"></div>
              </div>
              <div style="flex: 1;">
                <label>Plataforma</label>
                <div class="field"><input id="t_plataforma" list="l_metodos" class="pill" type="text" placeholder="Nequi..."></div>
              </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
              <div style="flex: 1;">
                <label>Fecha de la transferencia</label>
                <div class="field"><input id="t_fecha" class="pill" type="date"></div>
              </div>
              <div style="flex: 1;">
                <label>Hora</label>
                <div class="field"><input id="t_hora" class="pill" type="time"></div>
              </div>
            </div>
            
            <button id="btnBuscarInteligente" type="button" class="cta" style="margin-top:5px; background:var(--ink);" onclick="buscarTransferenciasUI('btnBuscarInteligente', 't_fecha', 't_hora', 't_monto', 't_ref', 't_plataforma', 'feedbackTransfer', 'v_referenciaAbono', 'v_primerAbono', 'v_metodoPago')">Buscar transferencia</button>
          </div>
          <div id="feedbackTransfer" class="hint"></div>
        </div>

        <div class="section-card">
          <div class="section-title">Detalle del Pago</div>
          <div class="vertical-form">
            <div><label>Valor a Abonar</label><div class="field"><input id="v_primerAbono" class="pill" type="number" min="0" value="0"></div></div>
            <div>
              <label>M√©todo / Plataforma</label>
              <div class="field">
                <input id="v_metodoPago" list="l_metodos" class="pill" type="text" placeholder="Ej: Nequi, Bancolombia">
                <datalist id="l_metodos"><option value="Nequi"></option><option value="Bancolombia"></option><option value="Efectivo"></option></datalist>
              </div>
            </div>
            <div>
              <label>Referencia</label>
              <div style="display:flex; gap:8px;">
                <div class="field" style="flex:1"><input id="v_referenciaAbono" class="pill" type="text"></div>
                <button id="btnForzarPendiente" type="button" style="border:none; border-radius:10px; padding:0 15px; background:var(--pill); color:var(--ink); font-weight:500; cursor:pointer; font-family:inherit; font-size: 0.85rem;">Pendiente</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button id="btnRegistrarVenta" class="cta" style="margin-top:10px; height:48px; font-size:1rem; background: var(--accent-2);">Confirmar Separado ($0)</button>
      <input id="v_contrasena" type="hidden">
    </div>

    <div id="view-cliente" class="view-section">
      <div class="section-card">
        <div class="section-title" style="margin-bottom: 16px;">CLIENTE ENCONTRADO</div>
        <div id="cliente-info-render"></div>
      </div>

      <div id="zonaPagosAbono" style="display: none;">
        <div class="section-card">
           <div class="section-title">BUSCAR PAGO INTELIGENTE</div>
           <div class="vertical-form">
              <div id="ocrDropAbono" class="ocr-drop">
                 Pega la imagen del comprobante aqu√≠ (Ctrl+V) para extraer Referencia<br>
                 <span id="ocrStatusAbono" style="color:var(--accent-2); font-weight:normal; margin-top: 4px; display: block;"></span>
              </div>

              <div style="display: flex; gap: 10px;">
                <div style="flex: 1;"><label>Referencia</label><div class="field"><input id="t_ref_abono" class="pill" type="text"></div></div>
                <div style="flex: 1;"><label>Valor</label><div class="field"><input id="t_monto_abono" class="pill" type="number"></div></div>
                <div style="flex: 1;"><label>Plataforma</label><div class="field"><input id="t_plataforma_abono" list="l_metodos" class="pill" type="text" placeholder="Nequi..."></div></div>
              </div>
              
              <div style="display: flex; gap: 10px;">
                <div style="flex: 1;"><label>Fecha (Transferencia)</label><div class="field"><input id="t_fecha_abono" class="pill" type="date"></div></div>
                <div style="flex: 1;"><label>Hora</label><div class="field"><input id="t_hora_abono" class="pill" type="time"></div></div>
              </div>
              
              <button id="btnBuscarInteligenteAbono" type="button" class="cta" style="margin-top:5px; background:var(--ink);" onclick="buscarTransferenciasUI('btnBuscarInteligenteAbono', 't_fecha_abono', 't_hora_abono', 't_monto_abono', 't_ref_abono', 't_plataforma_abono', 'feedbackTransferAbono', 'a_ref', 'a_monto', 'a_metodo')">Buscar transferencia</button>
           </div>
           <div id="feedbackTransferAbono" class="hint"></div>
        </div>

        <div class="section-card">
            <div class="section-title">NUEVO ABONO</div>
            <div class="vertical-form">
               <p id="infoDivisionAbono" style="font-size:0.85rem; margin-top:-10px; margin-bottom:5px;"></p>
               
               <div><label>Valor total a repartir</label><div class="field"><input type="number" id="a_monto" class="pill" placeholder="0"></div></div>
               <div><label>M√©todo de pago</label><div class="field"><input id="a_metodo" list="l_metodos" class="pill" type="text"></div></div>
               <div>
                 <label>Referencia</label>
                 <div style="display:flex; gap:8px;">
                   <div class="field" style="flex:1"><input type="text" id="a_ref" class="pill"></div>
                   <button id="btnForzarPendienteAbono" type="button" style="border:none; border-radius:10px; padding:0 15px; background:var(--pill); color:var(--ink); font-weight:500; cursor:pointer; font-family:inherit; font-size: 0.85rem;">Pendiente</button>
                 </div>
               </div>
            </div>
            <button id="btnRegistrarAbono" class="cta" onclick="registrarAbono()" style="margin-top:20px;">Registrar Abono</button>
        </div>
      </div>
    </div>
  <div id="modalConfirmAction" class="modal-overlay">
    <div class="modal-card">
      <h3 style="color:var(--ink); font-weight:600; font-size:1.2rem; margin:0 0 10px 0;">Aviso de Cliente</h3>
      <p id="mcMsg" style="color:var(--ink-2); font-size:0.9rem; margin-bottom:24px; line-height: 1.5;"></p>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="mcBtnCancel" class="cta" style="flex:1; background: transparent; border: 1px solid var(--ring-strong); color: var(--ink-2);">Cancelar</button>
        <button id="mcBtnOk" class="cta" style="flex:1; background: var(--ink);">S√≠, agregar</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  
  <script>
    const $ = id => document.getElementById(id);
    const feedback = $('searchFeedback');
    const topBar = $('topBar');
    const appShell = $('appShell');

    function activateAppMode() { topBar.classList.remove('hero-mode'); appShell.classList.add('visible'); }
    function activateHeroMode() { topBar.classList.add('hero-mode'); appShell.classList.remove('visible'); $('smartInput').value = ''; $('smartInput').focus(); setMode('separar'); }

    let modoVenta = 'separar'; 
    function setMode(mode) {
      modoVenta = mode;
      const btnAbono = $('btnModeAbono'); const btnSeparar = $('btnModeSeparar');
      const paySection = $('paymentSections'); const btnReg = $('btnRegistrarVenta');
      if (mode === 'separar') {
        btnSeparar.classList.add('active'); btnAbono.classList.remove('active');
        paySection.style.display = 'none';
        btnReg.textContent = 'Confirmar Separado ($0)'; btnReg.style.background = 'var(--accent-2)'; 
      } else {
        btnAbono.classList.add('active'); btnSeparar.classList.remove('active');
        paySection.style.display = 'block'; 
        btnReg.textContent = 'Registrar Venta'; btnReg.style.background = 'var(--accent)'; 
      }
    }

    const numList = $('numList');
    function makeNumPill(value=''){
      const wrap = document.createElement('div'); wrap.className='num-pill';
      const inp = document.createElement('input'); inp.type='text'; inp.maxLength=4; inp.value=value;
      const del = document.createElement('button'); del.className='chip-del'; del.textContent='‚úï';
      del.onclick = ()=>{ wrap.remove(); if(!numList.children.length) addDefaultPill(); };
      wrap.append(inp, del); return wrap;
    }
    function addDefaultPill(){ numList.appendChild(makeNumPill()); }
    $('btnAddNum').onclick = ()=> numList.appendChild(makeNumPill());

    const STORAGE_KEY = 'asesor_pwd';
    function initLogin(){ const s=localStorage.getItem(STORAGE_KEY); if(s) verifyLogin(s,true); }
    $('btnLogin').onclick = ()=> verifyLogin($('loginPwd').value);
    $('btnLogout').onclick = ()=> { localStorage.removeItem(STORAGE_KEY); location.reload(); };
    
    async function verifyLogin(pwd, auto=false){
      if(!pwd) { 
          if(!auto) alert("Por favor ingresa la contrase√±a."); 
          return; 
      }
      const btn = $('btnLogin'); const msg = $('loginMsg');
      if(!auto) { btn.textContent = 'Verificando...'; btn.disabled = true; msg.textContent = ''; }
      try {
          const req = await fetch('/api/admin/login', {
              method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contrasena: pwd })
          });
          const res = await req.json();
          if(!auto) { btn.textContent = 'Ingresar'; btn.disabled = false; }
          if(res.status === 'ok') {
              localStorage.setItem(STORAGE_KEY, pwd); 
              $('loginOverlay').style.display='none'; 
              topBar.style.display='block'; 
              $('asesorDisplay').textContent = res.asesor; 
              $('v_contrasena').value = pwd; 
              $('smartInput').focus();
              cargarPlataformas(); // <--- Hace que la lista se llene sola
          } else {
              if(!auto) msg.textContent = 'Contrase√±a incorrecta';
              localStorage.removeItem(STORAGE_KEY);
          }
      } catch (error) {
          if(!auto) { btn.textContent = 'Ingresar'; btn.disabled = false; msg.textContent = 'Error de conexi√≥n'; }
      }
    }

    // ==========================================
    // PORTAPAPELES MAGICO
    // ==========================================
    const smartInput = $('smartInput');
    smartInput.addEventListener('paste', (e) => {
        const pasteData = (e.clipboardData || window.clipboardData).getData('text');
        const lines = pasteData.split(/\r?\n/).map(l => l.trim()).filter(l => l);
        if (lines.length >= 3) {
            e.preventDefault();
            activateAppMode(); switchView('view-venta');
            if(lines.length>0) $('v_nombre').value = lines[0];
            if(lines.length>1) $('v_apellido').value = lines[1];
            if(lines.length>2) $('v_ciudad').value = lines[2];
            if(lines.length>3) {
                const nums = lines[3].split(',').map(n=>n.replace(/\D+/g,'')).filter(n=>n);
                numList.innerHTML=''; nums.forEach(n=>numList.appendChild(makeNumPill(n))); if(!nums.length) addDefaultPill();
            }
            if(lines.length>4) $('v_telefono').value = lines[4];
            showModal('Pegado M√°gico', 'Datos distribuidos correctamente.'); smartInput.value = '';
        }
    });

    smartInput.onkeydown = (e)=>{ if(e.key==='Enter') runSearch(); };
    $('btnSearch').onclick = runSearch;
    function switchView(id){ document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('active')); $(id).classList.add('active'); }

    // ==========================================
    // OCR: LECTURA DE COMPROBANTES
    // ==========================================
    async function preprocessBlobToCanvas(blob){
      return new Promise((resolve)=>{
        const img = new Image(); img.onload = ()=>{
          const w = img.naturalWidth || img.width, h = img.naturalHeight || img.height;
          const scale = Math.min(1.5, 1200 / Math.max(w,h));
          const W = Math.round(w*scale), H = Math.round(h*scale);
          const cv = document.createElement('canvas'); cv.width = W; cv.height = H;
          const ctx = cv.getContext('2d'); ctx.drawImage(img, 0, 0, W, H); resolve(cv);
        }; img.onerror = ()=> resolve(null); img.src = URL.createObjectURL(blob);
      });
    }
    function extractRefFromText(txt){ return (txt.toUpperCase().match(/[A-Z0-9]{6,24}/g) || [])[0] || ''; }

    // NUEVA FUNCI√ìN: Busca autom√°ticamente en la base de datos
    async function autoBuscarPorReferencia(refVal, refId, montoId, metodoId, feedbackId, statusId) {
        try {
            const req = await fetch('/api/admin/transferencias', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ referencia: refVal })
            });
            const res = await req.json();
            
            if(res.status === 'ok' && res.lista.length > 0) {
                const t = res.lista[0];
                if(t.status === 'LIBRE') {
                    // Si la encuentra y est√° libre, la auto-selecciona y bloquea los campos
                    seleccionarTransferencia(refId, montoId, metodoId, feedbackId, t.referencia, t.monto, t.plataforma);
                    document.getElementById(statusId).textContent = "¬°Datos encontrados y cargados! ‚úÖ";
                } else {
                    document.getElementById(statusId).textContent = "‚ö†Ô∏è La transferencia " + refVal + " ya est√° " + t.status;
                }
            } else {
                document.getElementById(statusId).textContent = "Ref: " + refVal + " (No encontrada en Base de Datos)";
            }
        } catch (e) {
            document.getElementById(statusId).textContent = "Ref: " + refVal + " (Error buscando en BD)";
        }
    }

    // OCR ACTUALIZADO
    async function handleOCR(e, statusId, inputId, montoId, metodoId, feedbackId) {
        var items = (e.clipboardData && e.clipboardData.items) ? e.clipboardData.items : [];
        for(var i=0; i<items.length; i++){ 
            var it = items[i];
            if(it.type && it.type.indexOf('image/') === 0){ 
                document.getElementById(statusId).textContent = 'Leyendo la imagen...';
                var f = it.getAsFile(); 
                var pre = await preprocessBlobToCanvas(f);
                var res = await Tesseract.recognize(pre || f, 'spa+eng');
                var ref = extractRefFromText(res.data.text);
                
                if(ref) { 
                    document.getElementById(inputId).value = ref; 
                    document.getElementById(statusId).textContent = "Ref extra√≠da: " + ref + " (Buscando... ‚è≥)";
                    
                    // Llama a la b√∫squeda autom√°tica instant√°neamente
                    await autoBuscarPorReferencia(ref, inputId, montoId, metodoId, feedbackId, statusId);
                } else { 
                    document.getElementById(statusId).textContent = 'No se detect√≥ referencia clara.'; 
                }
            }
        }
    }

    // LE PASAMOS LAS CAJAS DE TEXTO EXTRA AL OCR PARA QUE SEPA D√ìNDE PEGAR EL DINERO
    if ($('ocrDrop')) $('ocrDrop').addEventListener('paste', async (e)=>{ handleOCR(e, 'ocrStatus', 'v_referenciaAbono', 'v_primerAbono', 'v_metodoPago', 'feedbackTransfer'); });
    if ($('ocrDropAbono')) $('ocrDropAbono').addEventListener('paste', async (e)=>{ handleOCR(e, 'ocrStatusAbono', 'a_ref', 'a_monto', 'a_metodo', 'feedbackTransferAbono'); });


    // ==========================================
    // BUSCADOR INTELIGENTE DE TRANSFERENCIAS
    // ==========================================
    function seleccionarTransferencia(refId, montoId, metodoId, feedbackId, refVal, montoVal, metodoVal) {
        var refInput = document.getElementById(refId); var montoInput = document.getElementById(montoId); var metodoInput = document.getElementById(metodoId);
        refInput.value = refVal; montoInput.value = montoVal; metodoInput.value = metodoVal;
        refInput.readOnly = true; montoInput.readOnly = true; montoInput.readOnly = true;
        refInput.style.backgroundColor = "var(--pill)"; montoInput.style.backgroundColor = "var(--pill)"; metodoInput.style.backgroundColor = "var(--pill)";
        document.getElementById(feedbackId).innerHTML = '<span style="color:var(--accent-2); font-weight:500; font-size: 0.85rem;">Pago cargado. </span><span style="color:var(--danger); cursor:pointer; font-size:0.85rem; font-weight:500; text-decoration:underline; display:inline-block;" onclick="desbloquearCampos(\'' + refId + '\', \'' + montoId + '\', \'' + metodoId + '\', \'' + feedbackId + '\')">Limpiar datos</span>';
    }

    function desbloquearCampos(refId, montoId, metodoId, feedbackId) {
        var refInput = document.getElementById(refId); var montoInput = document.getElementById(montoId); var metodoInput = document.getElementById(metodoId);
        refInput.readOnly = false; montoInput.readOnly = false; montoInput.readOnly = false;
        refInput.value = ""; montoInput.value = ""; montoInput.value = "";
        refInput.style.backgroundColor = "transparent"; montoInput.style.backgroundColor = "transparent"; montoInput.style.backgroundColor = "transparent";
        if(feedbackId) document.getElementById(feedbackId).innerHTML = '';
    }

    async function buscarTransferenciasUI(btnId, fechaId, horaId, montoIdFiltro, refIdFiltro, plataformaIdFiltro, feedbackId, targetRefId, targetMontoId, targetMetodoId) {
        var fechaVal = document.getElementById(fechaId).value; 
        var horaVal = document.getElementById(horaId).value;
        var montoVal = document.getElementById(montoIdFiltro).value;
        var refVal = document.getElementById(refIdFiltro).value;
        var platVal = document.getElementById(plataformaIdFiltro).value; // Capturamos la plataforma
        var fb = document.getElementById(feedbackId);
        var btn = document.getElementById(btnId);

        if(!fechaVal && !montoVal && !refVal && !horaVal && !platVal) { fb.innerHTML = "<span class='hint err'>Ingresa al menos un dato.</span>"; return; }

        var originalTxt = btn.textContent;
        btn.textContent = "Buscando..."; btn.disabled = true; fb.innerHTML = "";

        // Empacamos la plataforma junto con los otros datos
        var payload = { fecha: fechaVal, hora: horaVal, monto: montoVal, referencia: refVal, plataforma: platVal };

        try {
            const req = await fetch('/api/admin/transferencias', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const res = await req.json();

            btn.textContent = originalTxt; btn.disabled = false;

            if(res.status === 'ok') {
                if(res.lista.length === 0) {
                    fb.innerHTML = "<span class='hint err'>No se encontr√≥ transferencia.</span>";
                } else {
                    var html = '<div style="display:grid; gap:8px; margin-top:10px;">';
                    for(var i=0; i<res.lista.length; i++){
                        var t = res.lista[i];
                        var montoFmt = new Intl.NumberFormat('es-CO').format(t.monto);
                        var refSafe = t.referencia ? t.referencia.replace(/'/g, "\\'") : ''; 
                        var platSafe = t.plataforma ? t.plataforma.replace(/'/g, "\\'") : '';
                        html += '<div onclick="seleccionarTransferencia(\'' + targetRefId + '\', \'' + targetMontoId + '\', \'' + targetMetodoId + '\', \'' + feedbackId + '\', \'' + refSafe + '\', ' + t.monto + ', \'' + platSafe + '\')"';
                        html += ' style="border:1px solid var(--ring); padding:10px; border-radius:10px; cursor:pointer; background:#fff; text-align:left; transition:background 0.2s;"';
                        html += ' onmouseover="this.style.background=\'var(--bg)\'" onmouseout="this.style.background=\'#fff\'">';
                        html += '<div style="font-weight:600; color:var(--ink-2); font-size:0.9rem;">' + t.plataforma + ' - $' + montoFmt + '</div>';
                        html += '<div style="font-size:0.8rem; color:var(--muted);">Ref: ' + t.referencia + ' | Fecha: ' + t.fecha + '</div>';
                        html += '<div style="font-size:0.75rem; color:var(--danger); font-weight:500; margin-top:4px;">' + (t.status || 'LIBRE') + '</div>';
                        html += '</div>';
                    }
                    html += '</div>';
                    fb.innerHTML = html;
                }
            } else {
                fb.innerHTML = "<span class='hint err'>Error: " + res.mensaje + "</span>";
            }
        } catch(e) {
            btn.textContent = originalTxt; btn.disabled = false;
            fb.innerHTML = "<span class='hint err'>Error de conexi√≥n.</span>";
        }
    }


    // ==========================================
    // BUSCADOR EXCLUSIVO DE REFERENCIAS Y LIBERACI√ìN
    // ==========================================
    async function buscarReferenciaEspecifica() {
        const ref = document.getElementById('inputBuscarRef').value.trim();
        const div = document.getElementById('resultadoReferencia');
        const btn = document.getElementById('btnBuscarRef');

        if(!ref) return alert('Por favor ingresa una referencia para buscar.');

        btn.textContent = "Buscando..."; btn.disabled = true;
        div.innerHTML = '<p style="text-align:center; color:var(--muted); font-size:0.85rem;">Buscando en base de datos...</p>';

        try {
            const req = await fetch('/api/admin/buscar-referencia', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ referencia: ref, contrasena: localStorage.getItem(STORAGE_KEY) })
            });
            const res = await req.json();

            btn.textContent = "Buscar Referencia"; btn.disabled = false;

            if(res.status !== 'ok') {
                div.innerHTML = `<p style="text-align:center; color:var(--danger); font-size:0.85rem; font-weight:500;">${res.mensaje}</p>`;
                return;
            }

            const formatMoney = new Intl.NumberFormat('es-CO').format(res.transferencia?.monto || res.data?.monto || 0);

            if (res.tipo === 'LIBRE') {
                div.innerHTML = `
                  <div style="background:var(--pill); border:1px solid var(--ring-strong); padding:16px; border-radius:12px;">
                     <div style="font-weight:600; color:var(--ink); font-size:1.05rem;">${res.data.plataforma} - $${formatMoney}</div>
                     <div style="color:var(--muted); font-size:0.85rem; margin-top:4px;">Ref: ${res.data.referencia} | Fecha: ${new Date(res.data.fecha_pago).toLocaleDateString('es-CO')}</div>
                     <div style="margin-top:12px; display:inline-block; background:#e8f5e9; color:#2e7d32; padding:4px 12px; border-radius:8px; font-size:0.8rem; font-weight:600;">Estado: LIBRE</div>
                     <p style="font-size:0.8rem; color:var(--muted); margin-top:8px; margin-bottom:0;">Esta transferencia no est√° asignada a nadie, est√° lista para usarse.</p>
                  </div>
                `;
            } else if (res.tipo === 'ASIGNADA') {
                div.innerHTML = `
                  <div style="background:var(--bg); border:1px solid var(--ring-strong); padding:16px; border-radius:12px;">
                     <div style="font-weight:600; color:var(--ink); font-size:1.05rem;">${res.transferencia.plataforma} - $${formatMoney}</div>
                     <div style="color:var(--muted); font-size:0.85rem; margin-top:4px;">Ref: ${res.transferencia.referencia} | Fecha: ${new Date(res.transferencia.fecha_pago).toLocaleDateString('es-CO')}</div>
                     <div style="margin-top:12px; display:inline-block; background:var(--danger-bg); color:var(--danger); padding:4px 12px; border-radius:8px; font-size:0.8rem; font-weight:600;">Asignada a Boleta: ${res.abono.numero_boleta}</div>
                     
                     <button onclick="liberarReferenciaDesdeBusqueda('${res.abono.id}')" style="margin-top:16px; width:100%; background:transparent; border:1px solid var(--danger); color:var(--danger); padding:10px; border-radius:10px; font-weight:600; cursor:pointer; font-family:inherit; transition:0.2s;" onmouseover="this.style.background='var(--danger-bg)'" onmouseout="this.style.background='transparent'">
                         Liberar y Desasignar
                     </button>
                  </div>
                `;
            } else {
               div.innerHTML = `<p style="text-align:center; color:var(--danger); font-size:0.85rem; font-weight:500;">La transferencia est√° marcada como asignada, pero no se encontr√≥ la boleta vinculada.</p>`;
            }

        } catch(e) {
            btn.textContent = "Buscar Referencia"; btn.disabled = false;
            div.innerHTML = `<p style="text-align:center; color:var(--danger); font-size:0.85rem; font-weight:500;">Error de conexi√≥n.</p>`;
        }
    }

    async function liberarReferenciaDesdeBusqueda(idAbono) {
        if(!confirm("¬øSeguro que deseas liberar esta transferencia? Esto eliminar√° el abono de la boleta y el cliente perder√° este dinero en su deuda.")) return;

        try {
            // Reutilizamos tu API m√°gica de eliminar-abono que ya hace todo esto perfecto
            const req = await fetch('/api/admin/eliminar-abono', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: idAbono, contrasena: localStorage.getItem(STORAGE_KEY) })
            });
            const res = await req.json();
            
            if(res.status === 'ok') {
                showModal('Liberaci√≥n Exitosa', 'El abono fue eliminado, la boleta fue actualizada y la transferencia volvi√≥ a quedar libre.');
                document.getElementById('resultadoReferencia').innerHTML = '';
                document.getElementById('inputBuscarRef').value = '';
            } else {
                showModal('Error', res.mensaje);
            }
        } catch(e) {
            showModal('Error', 'Error de conexi√≥n.');
        }
    }


    // ==========================================
    // CONEXION A VERCEL (BUSQUEDA, VENTA, ABONO)
    // ==========================================
    let esVentaPendiente = false; let esAbonoPendiente = false;
    $('btnForzarPendiente').onclick = ()=>{ if(!$('v_referenciaAbono').value) return alert('Pon referencia'); esVentaPendiente=true; $('feedbackTransfer').textContent='Modo Pendiente Activo'; };
    $('btnForzarPendienteAbono').onclick = ()=>{ if(!$('a_ref').value) return alert('Pon referencia'); esAbonoPendiente=true; $('feedbackTransferAbono').textContent='Modo Pendiente Activo'; };

    async function runSearch(){
      const q = smartInput.value.trim(); if(!q) return;
      feedback.textContent = "Buscando...";

      // --- NUEVO: LIMPIAR CAJAS DE PAGO INTELIGENTE AL BUSCAR ---
      
      // 1. Limpiamos los campos de la vista de "Boletas a separar" (Ventas)
      if(document.getElementById('t_ref')) document.getElementById('t_ref').value = '';
      if(document.getElementById('t_monto')) document.getElementById('t_monto').value = '';
      if(document.getElementById('t_fecha')) document.getElementById('t_fecha').value = '';
      if(document.getElementById('t_hora')) document.getElementById('t_hora').value = '';
      if(document.getElementById('t_plataforma')) document.getElementById('t_plataforma').value = '';
      if(document.getElementById('ocrStatus')) document.getElementById('ocrStatus').textContent = '';
      if(document.getElementById('feedbackTransfer')) document.getElementById('feedbackTransfer').innerHTML = '';
      
      // 2. Limpiamos los campos de la vista de "Cliente Encontrado" (Abonos)
      if(document.getElementById('t_ref_abono')) document.getElementById('t_ref_abono').value = '';
      if(document.getElementById('t_monto_abono')) document.getElementById('t_monto_abono').value = '';
      if(document.getElementById('t_fecha_abono')) document.getElementById('t_fecha_abono').value = '';
      if(document.getElementById('t_hora_abono')) document.getElementById('t_hora_abono').value = '';
      if(document.getElementById('t_plataforma_abono')) document.getElementById('t_plataforma_abono').value = '';
      if(document.getElementById('ocrStatusAbono')) document.getElementById('ocrStatusAbono').textContent = '';
      if(document.getElementById('feedbackTransferAbono')) document.getElementById('feedbackTransferAbono').innerHTML = '';

      // 3. Desbloqueamos los campos por si hab√≠a un pago cargado previamente
      desbloquearCampos('v_referenciaAbono', 'v_primerAbono', 'v_metodoPago', 'feedbackTransfer');
      desbloquearCampos('a_ref', 'a_monto', 'a_metodo', 'feedbackTransferAbono');
      
      // ---------------------------------------------------------

      try {
        const response = await fetch('/api/admin/buscar?q=' + encodeURIComponent(q));
        const res = await response.json();
        feedback.textContent = "";
        if(res.tipo === 'ERROR_SERVIDOR') return showModal('Error', res.mensaje);
        if(res.tipo !== 'NO_EXISTE') activateAppMode();
        if(res.tipo==='BOLETA_DISPONIBLE'){ switchView('view-venta'); numList.innerHTML=''; numList.appendChild(makeNumPill(res.data.numero)); $('v_nombre').focus(); } 
        else if(res.tipo==='BOLETA_OCUPADA'){ switchView('view-cliente'); renderClienteInfo([res.data.infoVenta]); } 
        else if(res.tipo==='CLIENTE_ENCONTRADO'){ switchView('view-cliente'); renderClienteInfo(res.lista); } 
        else if(res.tipo==='CLIENTE_SIN_BOLETAS') {
            // 1. Escribimos el mensaje en el cuadro bonito y lo mostramos
            $('mcMsg').innerHTML = `El cliente <b>${res.data.nombre || ''} ${res.data.apellido || ''}</b> est√° registrado, pero NO tiene boletas en este momento.<br><br>¬øDeseas agregarle nuevas boletas?`;
            $('modalConfirmAction').style.display = 'flex';
            
            // 2. Si el asesor presiona "S√≠, agregar"
            $('mcBtnOk').onclick = function() {
                $('modalConfirmAction').style.display = 'none'; // Cierra el cuadro
                activateAppMode();
                switchView('view-venta');
                $('v_nombre').value = res.data.nombre || '';
                $('v_apellido').value = res.data.apellido || '';
                $('v_telefono').value = res.data.telefono || '';
                $('v_ciudad').value = res.data.ciudad || '';
                
                numList.innerHTML = '';
                addDefaultPill(); // Prepara el espacio para escribir la boleta
                setMode('separar');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            
            // 3. Si el asesor presiona "Cancelar"
            $('mcBtnCancel').onclick = function() {
                $('modalConfirmAction').style.display = 'none'; // Cierra el cuadro
                $('smartInput').value = '';
                $('smartInput').focus();
            };
        }
        else { showModal('No encontrado', res.mensaje || 'Intenta de nuevo'); }
      } catch (err) { feedback.textContent = ""; showModal('Error', err.message); }
    }

$('btnRegistrarVenta').onclick = async ()=>{
       const nums = Array.from(numList.querySelectorAll('input')).map(i=>i.value).filter(v=>v.length===4);
       if(!nums.length) return alert('Falta boleta v√°lida');
       $('btnRegistrarVenta').textContent='Procesando...'; $('btnRegistrarVenta').disabled=true;
       
       let totalMoney=0, ref='', metodo='';
       if (modoVenta === 'separar') { totalMoney=0; ref='0'; metodo='Separado'; } 
       else { totalMoney=Number($('v_primerAbono').value)||0; ref=$('v_referenciaAbono').value; metodo=$('v_metodoPago').value; }

       const perNum = Math.floor(totalMoney/nums.length);
       const baseData = { nombre:$('v_nombre').value, apellido:$('v_apellido').value, ciudad:$('v_ciudad').value, telefono:$('v_telefono').value, primerAbono:perNum, referenciaAbono: ref, metodoPago: metodo, esPendiente:esVentaPendiente, contrasena:localStorage.getItem(STORAGE_KEY) };
       
       let ok=0, fails=0;
       let detalleErrores = []; 

       for (let i=0; i < nums.length; i++) {
           try {
               const req = await fetch('/api/admin/venta', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({...baseData, numeroBoleta: nums[i]}) });
               const res = await req.json();
               if(res.status === 'ok') { ok++; } else { fails++; detalleErrores.push(`Boleta ${nums[i]}: ${res.mensaje}`); }
           } catch(e) { fails++; detalleErrores.push(`Boleta ${nums[i]}: Error de conexi√≥n`); }
       }
       $('btnRegistrarVenta').textContent= modoVenta === 'separar' ? 'Confirmar Separado ($0)' : 'Registrar Venta'; 
       $('btnRegistrarVenta').disabled=false;
       
       let mensajeFinal = `Registradas: ${ok} / Errores: ${fails}`;
       if (fails > 0) { mensajeFinal += `\n\nMotivos:\n` + detalleErrores.join('\n'); }
       
       $('mMsg').style.whiteSpace = 'pre-line'; 
       showModal('Resumen de Venta', mensajeFinal);
       
       if(fails===0){ 
           // LIMPIEZA DE DATOS PRINCIPALES
           $('v_nombre').value=''; $('v_apellido').value=''; $('v_telefono').value=''; $('v_ciudad').value=''; $('v_primerAbono').value=0; $('v_referenciaAbono').value=''; $('v_metodoPago').value='';
           
           // LIMPIEZA DE B√öSQUEDA INTELIGENTE Y OCR
           if(document.getElementById('t_ref')) document.getElementById('t_ref').value=''; 
           if(document.getElementById('t_monto')) document.getElementById('t_monto').value=''; 
           if(document.getElementById('t_fecha')) document.getElementById('t_fecha').value=''; 
           if(document.getElementById('t_hora')) document.getElementById('t_hora').value='';
           if(document.getElementById('t_plataforma')) document.getElementById('t_plataforma').value='';
           if(document.getElementById('ocrStatus')) document.getElementById('ocrStatus').textContent='';

           desbloquearCampos('v_referenciaAbono', 'v_primerAbono', 'v_metodoPago', 'feedbackTransfer');
           numList.innerHTML=''; addDefaultPill(); activateHeroMode();
       }
    };
    
    async function registrarAbono() {
        const btn = document.getElementById('btnRegistrarAbono');
        const checkboxes = document.querySelectorAll('.boleta-pay-checkbox:checked');
        const boletasTarget = Array.from(checkboxes).map(c => c.value);
        if(boletasTarget.length === 0) return alert("Selecciona al menos una boleta.");
        
        const montoTotal = Number(document.getElementById('a_monto').value); 
        const ref = document.getElementById('a_ref').value; 
        const metodo = document.getElementById('a_metodo').value;
        
        if(montoTotal <= 0) return alert("El monto debe ser mayor a 0.");
        
        const montoPorBoleta = Math.floor(montoTotal / boletasTarget.length);
        const textoOriginal = btn.textContent; btn.textContent = 'Procesando...'; btn.disabled = true;

        const basePayload = { metodoPago: metodo, referencia: ref || 'efectivo', esPendiente: esAbonoPendiente, contrasena: localStorage.getItem(STORAGE_KEY) };
        let ok = 0; let fails = 0;
        let detalleErrores = []; 

        for (let i=0; i < boletasTarget.length; i++) {
            try {
               const req = await fetch('/api/admin/abono', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ ...basePayload, numeroBoleta: boletasTarget[i], valorAbono: montoPorBoleta }) });
               const res = await req.json();
               
               if(res.status === 'ok') { ok++; } else { fails++; detalleErrores.push(`Boleta ${boletasTarget[i]}: ${res.mensaje}`); }
            } catch(e) { fails++; detalleErrores.push(`Boleta ${boletasTarget[i]}: Error de conexi√≥n del servidor`); }
        }
        
        btn.textContent = textoOriginal; btn.disabled = false;
        
        if (fails === 0) {
            showModal('√âxito', `Abono registrado correctamente.`);
            // LIMPIEZA DE DATOS PRINCIPALES
            document.getElementById('a_monto').value = ''; document.getElementById('a_ref').value = ''; document.getElementById('a_metodo').value = '';
            
            // üåü NUEVO: LIMPIEZA DE B√öSQUEDA INTELIGENTE Y OCR DE ABONOS
            document.getElementById('t_ref_abono').value=''; 
            document.getElementById('t_monto_abono').value=''; 
            document.getElementById('t_fecha_abono').value=''; 
            document.getElementById('t_hora_abono').value='';
            if(document.getElementById('ocrStatusAbono')) document.getElementById('ocrStatusAbono').textContent='';

            desbloquearCampos('a_ref', 'a_monto', 'a_metodo', 'feedbackTransferAbono');
            activateHeroMode(); 
        } else { 
            let mensajeFinal = `Se registraron ${ok}, fallaron ${fails}.\n\nMotivos del fallo:\n` + detalleErrores.join('\n');
            document.getElementById('mMsg').style.whiteSpace = 'pre-line';
            showModal('Aviso Importante', mensajeFinal); 
        }
    }

    function renderClienteInfo(lista){
       var c = lista[0]; 
       var boletasStr = [];
       var fmt = function(n) { return new Intl.NumberFormat('es-CO').format(n); };
       
       var html = '';
       
       // 1. CAJITAS DE SELECCI√ìN (Desmarcadas si hay m√°s de 1 boleta)
       html += '<div style="margin-bottom: 20px;">';
       html += '<label style="font-size:0.85rem; color:var(--ink-2); font-weight:600; margin-bottom:10px; display:block;">üëá Selecciona a qu√© boleta(s) vas a abonar:</label>';
       html += '<div style="display: flex; flex-direction: column; gap: 8px;">';

       var autoCheck = lista.length === 1 ? 'checked' : '';

       for(var i=0; i<lista.length; i++){
           var b = lista[i]; 
           var restante = Number(b.restante) || 0;
           boletasStr.push(b.numero);
           
           // Evaluamos si es diaria (2 cifras) o apto (4 cifras)
           var ticketEsDiaria = String(b.numero).length === 2;
           
           html += '<label style="display:flex; align-items:center; gap:8px; background:var(--bg); padding:10px; border-radius:10px; border:1px solid var(--ring-strong); cursor:pointer; font-size:0.9rem; width:100%; transition: 0.2s;">';
           html += '<input type="checkbox" value="' + b.numero + '" class="boleta-pay-checkbox" ' + autoCheck + ' onchange="verificarSeleccionAbonos()" style="accent-color: var(--accent); width:16px; height:16px; flex-shrink:0;">';
           
           // Textos con sus respectivas restas
           if (ticketEsDiaria) {
               html += '<span style="color:var(--ink); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1;"><b>' + b.numero + '</b> <span style="color:var(--muted); font-size:0.8rem;">(Diaria - Resta $' + fmt(restante) + ')</span></span>';
           } else {
               html += '<span style="color:var(--ink); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1;"><b>' + b.numero + '</b> <span style="color:var(--muted); font-size:0.8rem;">(Apto - Resta $' + fmt(restante) + ')</span></span>';
           }

           // Contenedor de Botones Laterales
           html += '<div style="display:flex; gap:6px; flex-shrink:0;">';
           
           // El bot√≥n de copiar link SOLO se muestra si NO es diaria (es decir, es del Apartamento)
           if (!ticketEsDiaria) {
               html += '<button type="button" onclick="event.preventDefault(); event.stopPropagation(); copiarLinkBoleta(\'' + b.numero + '\');" style="background:#fff; border:1px solid var(--ring-strong); color:var(--ink-2); padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:500; font-family:inherit; cursor:pointer; transition:0.2s;">Copiar Link</button>';
           }
           
           html += '<button type="button" onclick="event.preventDefault(); event.stopPropagation(); confirmarLiberarBoleta(\'' + b.numero + '\');" style="background:transparent; color:var(--danger); border:1px solid var(--danger); padding:4px 10px; border-radius:6px; font-size:0.75rem; font-weight:500; font-family:inherit; cursor:pointer; transition: 0.2s;">Liberar</button>';
           html += '</div>';
           
           html += '</label>';
       }
       html += '</div></div>';

       // 2. DATOS DEL CLIENTE
       // Revisamos si las boletas tienen un asesor asignado para mostrarlo
       var asesoresVenta = [...new Set(lista.map(b => b.asesor).filter(a => a))].join(', ');
       var htmlAsesor = asesoresVenta ? `<span style="color:var(--accent-2); font-weight:600; font-size:0.75rem; background:var(--pill); padding:2px 8px; border-radius:8px;">üë§ Asesor: ${asesoresVenta}</span>` : '';

       html += '<div style="margin-bottom:20px; padding-top: 15px; border-top: 1px solid var(--ring);">';
       
       html += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">';
       html += '  <label style="font-size:0.85rem; color:var(--ink-2); font-weight:500; margin:0;">Datos personales:</label>';
       html +=    htmlAsesor;
       html += '</div>';
       
       html += '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:8px;">';
       html += '  <input id="c_nombre" type="text" class="main-input" style="padding:8px 12px;" value="' + c.nombre + '">';
       html += '  <input id="c_apellido" type="text" class="main-input" style="padding:8px 12px;" value="' + c.apellido + '">';
       html += '</div>';
       html += '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:12px;">';
       html += '  <input id="c_telefono_display" type="text" class="main-input" style="padding:8px 12px; background:var(--bg); color:var(--muted);" value="' + c.telefono + '" disabled>';
       html += '  <input id="c_ciudad" type="text" class="main-input" style="padding:8px 12px;" value="' + c.ciudad + '">';
       html += '</div>';
       html += '<div style="display:flex; gap:10px; flex-wrap:wrap;">';        html += '  <button type="button" onclick="guardarCambiosCliente(\'' + c.telefono + '\', this)" class="cta" style="flex:1; padding:8px 20px; margin:0; font-size:0.85rem;">Guardar cambios</button>';        html += '  <button type="button" onclick="prepararNuevaVentaExistente(\'' + c.telefono + '\')" class="cta" style="flex:1; padding:8px 20px; margin:0; font-size:0.85rem; background:var(--ink);">‚ûï Agregar Boletas</button>';        html += '</div>';
       html += '</div>';

       // 3. ZONA DE HISTORIAL DE PAGOS (El bloque rojo global fue eliminado)
       html += '<div style="margin-top: 24px; padding-top: 15px; border-top: 1px solid var(--ring);">';
       html += '  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid var(--ring); padding-bottom: 8px;">';
       html += '    <div style="font-weight: 600; color: var(--ink); font-size: 0.95rem;">HISTORIAL DE PAGOS</div>';
       
       html += '    <select id="boletaSelector" style="background:var(--bg); border:1px solid var(--ring-strong); border-radius:8px; padding:4px 8px; font-weight:500; font-size:0.85rem; color:var(--ink-2); outline:none; font-family:inherit;" onchange="cargarHistorialAbonos(this.value)">';
       for(var i=0; i<boletasStr.length; i++) {
           html += '<option value="'+boletasStr[i]+'">Boleta '+boletasStr[i]+'</option>';
       }
       html += '    </select>';
       html += '  </div>';
       html += '  <div id="historial-abonos-render"><p style="text-align:center; color:var(--muted); font-size:0.85rem; margin:10px 0;">Cargando...</p></div>';
       html += '</div>';
       
       document.getElementById('cliente-info-render').innerHTML = html;

       if(boletasStr.length > 0) cargarHistorialAbonos(boletasStr[0]);
       
       verificarSeleccionAbonos();
    }

    function verificarSeleccionAbonos() {
        const checkboxes = document.querySelectorAll('.boleta-pay-checkbox:checked');
        const zonaPagos = document.getElementById('zonaPagosAbono');
        const lblInfo = document.getElementById('infoDivisionAbono');

        if (checkboxes.length > 0) {
            zonaPagos.style.display = 'block'; // Muestra la zona de pago
            if (lblInfo) {
                if(checkboxes.length === 1) {
                    lblInfo.innerHTML = 'El abono ir√° 100% a la boleta <b>' + checkboxes[0].value + '</b>.';
                    lblInfo.style.color = 'var(--accent-2)';
                } else {
                    lblInfo.innerHTML = '‚ö†Ô∏è El dinero se dividir√° uniformemente entre <b>' + checkboxes.length + '</b> boletas.';
                    lblInfo.style.color = 'var(--danger)';
                }
            }
        } else {
            zonaPagos.style.display = 'none'; // Esconde si todo est√° desmarcado
        }
    }

    async function copiarLinkBoleta(numero) {
        var link = window.location.origin + '/boleta/' + numero;
        try { 
            await navigator.clipboard.writeText(link); 
            // Mostramos la ventana de aviso amigable
            showModal('¬°Link Copiado!', 'Se copi√≥ el enlace de la boleta ' + numero + ' correctamente.'); 
        } catch(e) {
            alert('Error al copiar el link de la boleta.');
        }
    }

    async function cargarHistorialAbonos(numero) {
        const div = $('historial-abonos-render');
        div.innerHTML = '<p style="text-align:center; color:var(--muted); font-size:0.85rem;">Cargando historial...</p>';
        try {
            const req = await fetch('/api/admin/historial?numero=' + numero);
            const res = await req.json();
            if(res.status === 'ok') renderTablaAbonos(res.lista);
            else div.innerHTML = `<p style="text-align:center; color:var(--danger); font-size:0.85rem;">${res.mensaje}</p>`;
        } catch(e) {
            div.innerHTML = '<p style="text-align:center; color:var(--danger); font-size:0.85rem;">Error cargando historial.</p>';
        }
    }

    function renderTablaAbonos(lista) {
        const div = $('historial-abonos-render');
        if(!lista || lista.length === 0) {
            div.innerHTML = '<p style="text-align:center; color:var(--muted); font-size:0.85rem; margin:10px 0;">No hay abonos registrados.</p>';
            return;
        }

        let html = '<div style="overflow-x:auto;"><table style="width:100%; border-collapse:collapse; font-size:0.85rem; text-align:left;">';
        html += '<thead><tr style="border-bottom:1px solid var(--ring-strong); color: var(--muted); font-weight:500;"><th style="padding:8px 4px;">Fecha</th><th style="padding:8px 4px;">Valor</th><th style="padding:8px 4px;">Ref</th><th style="padding:8px 4px; text-align:right;"></th></tr></thead><tbody>';
        
        lista.forEach(a => {
            const valFmt = new Intl.NumberFormat('es-CO', {style:'currency', currency:'COP', minimumFractionDigits:0}).format(a.monto);
            const fechaLimpia = new Date(a.fecha_pago).toLocaleDateString('es-CO');
            
            html += `<tr style="border-bottom:1px solid var(--ring);">
                        <td style="padding:10px 4px; color:var(--ink-2);">${fechaLimpia}</td>
                        <td style="padding:10px 4px; font-weight:600; color:var(--ink);">${valFmt}</td>
                        <td style="padding:10px 4px; font-size:0.8rem; color:var(--muted); word-break: break-all;">${a.referencia_transferencia || '-'}</td>
                        <td style="padding:10px 4px; text-align:right;">
                            <button style="background:transparent; border:none; color:var(--danger); font-size:0.8rem; cursor:pointer; font-weight:500; font-family:inherit; padding:0;" 
                                onclick="confirmarEliminarAbono('${a.id}', this)">Borrar</button>
                        </td>
                    </tr>`;
        });
        html += '</tbody></table></div>';
        div.innerHTML = html;
    }

    async function confirmarEliminarAbono(idAbono, btnElement) {
        if(!confirm("¬øSeguro de eliminar este abono? Si us√≥ una transferencia de banco, quedar√° LIBRE nuevamente.")) return;
        
        btnElement.textContent = '...';
        btnElement.disabled = true;
        
        try {
            const req = await fetch('/api/admin/eliminar-abono', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: idAbono, contrasena: localStorage.getItem(STORAGE_KEY) })
            });
            const res = await req.json();
            
            if(res.status === 'ok') {
                showModal('Eliminado', 'Abono eliminado y saldos re-calculados.');
                runSearch(); 
            } else {
                showModal('Error', res.mensaje);
                btnElement.textContent = 'Borrar'; btnElement.disabled = false;
            }
        } catch(e) {
            showModal('Error', 'Error de conexi√≥n.');
            btnElement.textContent = 'Borrar'; btnElement.disabled = false;
        }
    }

    async function guardarCambiosCliente(telefono, btnElement) {
        const nombre = document.getElementById('c_nombre').value;
        const apellido = document.getElementById('c_apellido').value;
        const ciudad = document.getElementById('c_ciudad').value;
        const originalText = btnElement.innerHTML;

        btnElement.innerHTML = 'Guardando...';
        btnElement.disabled = true;

        try {
            const req = await fetch('/api/admin/actualizar-cliente', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    telefono: telefono,
                    nombre: nombre,
                    apellido: apellido,
                    ciudad: ciudad,
                    contrasena: localStorage.getItem(STORAGE_KEY)
                })
            });
            const res = await req.json();

            if (res.status === 'ok') {
                showModal('Guardado', res.mensaje);
            } else {
                showModal('Error', res.mensaje);
            }
        } catch(e) {
            showModal('Error', 'Error de conexi√≥n.');
        }
        
        btnElement.innerHTML = originalText;
        btnElement.disabled = false;
    }
    
    function showModal(title,msg){ $('mTitle').textContent=title; $('mMsg').textContent=msg; $('modalResult').style.display='flex'; }
    $('mBtn').onclick = function(){ $('modalResult').style.display='none'; };
    document.addEventListener('DOMContentLoaded', function() { initLogin(); if(typeof addDefaultPill === 'function') addDefaultPill(); $('loginPwd').addEventListener('keyup', function(e) { if (e.key === 'Enter') verifyLogin(this.value); }); });
  

async function confirmarLiberarBoleta(numero) {
        if(!confirm(`ATENCI√ìN: ¬øSeguro que quieres LIBERAR la boleta ${numero}? \n\nSe borrar√° su historial de pagos, se liberar√°n transferencias asociadas y podr√° ser vendida de nuevo.`)) return;
        
        const btn = document.getElementById('btnRegistrarAbono'); 
        const originalText = btn.textContent;
        btn.textContent = `Liberando boleta ${numero}...`;
        btn.disabled = true;
        
        try {
            const req = await fetch('/api/admin/liberar-boleta', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ numeroBoleta: numero, contrasena: localStorage.getItem(STORAGE_KEY) })
            });
            const res = await req.json();
            
            if(res.status === 'ok') {
                showModal('Boleta Liberada', res.mensaje);
                activateHeroMode(); 
            } else {
                showModal('Error', res.mensaje);
            }
        } catch(e) {
            showModal('Error', 'Error de conexi√≥n.');
        }
        btn.textContent = originalText;
        btn.disabled = false;
    }
    
async function procesarCSVBancos() {
    const fileInput = document.getElementById('fileBancos');
    if (!fileInput.files.length) return alert("Por favor, selecciona al menos un archivo CSV o PDF.");
    
    const btn = document.getElementById('btnProcesarBancos');
    const txtOriginal = btn.textContent;
    btn.textContent = `Procesando ${fileInput.files.length} archivo(s)...`;
    btn.disabled = true;

    try {
        let transferenciasNuevas = [];
        const meses = {'ene': '01', 'feb': '02', 'mar': '03', 'abr': '04', 'may': '05', 'jun': '06', 'jul': '07', 'ago': '08', 'sep': '09', 'oct': '10', 'nov': '11', 'dic': '12'};

        // Ciclo para procesar TODOS los archivos seleccionados
        for (let f = 0; f < fileInput.files.length; f++) {
            const file = fileInput.files[f];

            if (file.name.toLowerCase().endsWith('.pdf')) {
                // --- L√ìGICA: EXTRAER DATOS DEL NUEVO PDF DE BANCOLOMBIA ---
                const arrayBuffer = await file.arrayBuffer();
                const pdfjsLib = window['pdfjs-dist/build/pdf'];
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
                
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = "";
                
                // Leemos el PDF respetando los saltos de l√≠nea (\n)
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    fullText += content.items.map(item => item.str).join('\n') + "\n";
                }

                // 1. Extraer Referencia
                let refMatch = fullText.match(/Referencia 1\s*\n(\d+)/);
                let referencia = refMatch ? refMatch[1] : "Sin Ref";

                // 2. Extraer Valor (Limpia formatos como "COP $ 20.000 ,00")
                let valorMatch = fullText.match(/COP \$ ([\d\.,\s]+)/);
                let monto = 0;
                if (valorMatch) {
                    let valorLimpio = valorMatch[1].replace(/\./g, '').replace(/\s/g, '').split(',')[0];
                    monto = parseInt(valorLimpio) || 0;
                }

                // 3. Extraer Fecha y HORA
                let fechaMatch = fullText.match(/Fecha de aplicaci√≥n\s*\n(.*?)\n(\d{2}:\d{2}:\d{2})/);
                let fecha_pago = new Date().toISOString().split('T')[0]; 
                let hora_pago = null;

                if(fechaMatch) {
                    let partes = fechaMatch[1].trim().split(" ");
                    if(partes.length >= 3) {
                        let dia = partes[0].padStart(2, '0');
                        let mes = meses[partes[1].toLowerCase()] || '01';
                        let anio = partes[2];
                        fecha_pago = `${anio}-${mes}-${dia}`;
                    }
                    hora_pago = fechaMatch[2]; // Ej: "19:04:56"
                }

                // 4. Plataforma
                let descUpper = fullText.toUpperCase();
                let plataforma = 'Bancolombia';
                if (descUpper.includes('TRANSFERENCIA DESDE NEQUI') || descUpper.includes('TRANSFERENCIA NEQUI')) {
                    plataforma = 'Nequi';
                } else if (descUpper.includes('CORRESPONSAL')) {
                    plataforma = 'Corresponsal';
                }

                if (monto > 0) {
                    transferenciasNuevas.push({
                        monto: monto,
                        fecha_pago: fecha_pago,
                        hora_pago: hora_pago, 
                        plataforma: plataforma,
                        referencia: referencia,
                        estado: 'LIBRE'
                    });
                }

            } else {
                // --- L√ìGICA ORIGINAL CSV (Se mantiene intacta) ---
                const text = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsText(file);
                });
                const rows = text.split('\n');
                for(let i = 0; i < rows.length; i++) {
                    const row = rows[i].trim();
                    if(!row) continue;
                    const cols = row.split(',');
                    if(cols.length < 12) continue; 

                    let monto = parseFloat(cols[9]) || 0;
                    if(monto <= 0) continue;

                    let fechaRaw = cols[1]; 
                    let soloFechaCSV = new Date().toISOString().split('T')[0]; 
                    if(fechaRaw && fechaRaw.length === 8) {
                        soloFechaCSV = `${fechaRaw.slice(4,8)}-${fechaRaw.slice(2,4)}-${fechaRaw.slice(0,2)}`;
                    }
                    
                    let descUpper = (cols[10] || "").toUpperCase();
                    let plataforma = 'Bancolombia'; 
                    if (descUpper.includes('CORRESP')) {
                        plataforma = 'Corresponsal';
                    } else if (descUpper.includes('NEQUI')) {
                        plataforma = 'Nequi';
                    }

                    let refCol = (cols[11] || "").replace(/"/g, ''); 

                    transferenciasNuevas.push({
                        monto: monto, 
                        fecha_pago: soloFechaCSV, 
                        hora_pago: null, 
                        plataforma: plataforma, 
                        referencia: refCol, 
                        estado: 'LIBRE'
                    });
                }
            }
        } // Fin del ciclo de archivos

        if(transferenciasNuevas.length === 0) {
            throw new Error("No se encontraron transferencias v√°lidas en los archivos.");
        }

        // Se env√≠a a tu API api/admin/subir-bancos.js
        const req = await fetch('/api/admin/subir-bancos', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                transferencias: transferenciasNuevas,
                contrasena: localStorage.getItem(STORAGE_KEY)
            })
        });
        const res = await req.json();

        if(res.status === 'ok') {
            showModal('Procesado', res.mensaje);
            fileInput.value = ""; 
        } else {
            showModal('Error al subir', res.mensaje);
        }

    } catch(error) {
        showModal('Error', error.message || 'No se pudo procesar el archivo.');
    } finally {
        btn.textContent = txtOriginal; 
        btn.disabled = false;
    }
}

// ==========================================
    // HISTORIAL GLOBAL DE √öLTIMOS MOVIMIENTOS
    // ==========================================
    async function cargarUltimosMovimientos() {
        const div = document.getElementById('tablaMovimientosRender');
        div.innerHTML = '<p style="text-align:center; color:var(--muted); font-size:0.85rem;">Cargando movimientos...</p>';
        
        try {
            const req = await fetch('/api/admin/ultimos-movimientos', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contrasena: localStorage.getItem(STORAGE_KEY) })
            });
            const res = await req.json();
            
            if (res.status === 'ok') {
                if(res.lista.length === 0) {
                    div.innerHTML = '<p style="text-align:center; color:var(--muted); font-size:0.85rem;">No hay movimientos recientes.</p>';
                    return;
                }

                let html = '<div style="overflow-x:auto;"><table style="width:100%; border-collapse:collapse; font-size:0.85rem; text-align:left;">';
                html += '<thead><tr style="border-bottom:1px solid var(--ring-strong); color: var(--muted); font-weight:500;"><th style="padding:8px 4px;">Fecha</th><th style="padding:8px 4px;">Asesor</th><th style="padding:8px 4px;">Acci√≥n</th><th style="padding:8px 4px;">Boleta</th><th style="padding:8px 4px;">Detalle</th></tr></thead><tbody>';
                
                res.lista.forEach(m => {
                    let fechaString = m.created_at;
if (!fechaString.includes('Z') && !fechaString.includes('+')) {
    fechaString += 'Z';
}
const fechaObj = new Date(fechaString);
const opcionesFecha = { timeZone: 'America/Bogota' };
const opcionesHora = { timeZone: 'America/Bogota', hour: '2-digit', minute:'2-digit' };
const fechaStr = fechaObj.toLocaleDateString('es-CO', opcionesFecha) + ' ' + fechaObj.toLocaleTimeString('es-CO', opcionesHora);
                    
                    let colorAccion = 'var(--ink)';
                    if (m.accion === 'Eliminar Abono' || m.accion === 'Liberar Boleta') colorAccion = 'var(--danger)';
                    if (m.accion === 'Nuevo Abono') colorAccion = 'var(--accent-2)';

                    html += `<tr style="border-bottom:1px solid var(--ring);">
                                <td style="padding:10px 4px; color:var(--ink-2); font-size:0.8rem; white-space: nowrap;">${fechaStr}</td>
                                <td style="padding:10px 4px; font-weight:600; color:var(--ink);">${m.asesor}</td>
                                <td style="padding:10px 4px; color:${colorAccion}; font-weight:600; white-space: nowrap;">${m.accion}</td>
                                <td style="padding:10px 4px; font-weight:800;">${m.boleta}</td>
                                <td style="padding:10px 4px; color:var(--muted); font-size:0.8rem;">${m.detalle}</td>
                            </tr>`;
                });
                html += '</tbody></table></div>';
                div.innerHTML = html;
            } else {
                div.innerHTML = `<p style="text-align:center; color:var(--danger); font-size:0.85rem;">${res.mensaje}</p>`;
            }
        } catch(e) {
            div.innerHTML = '<p style="text-align:center; color:var(--danger); font-size:0.85rem;">Error cargando movimientos.</p>';
        }
    }

  // ==========================================
    // ESTAD√çSTICAS EN TABLA DIARIA
    // ==========================================
    async function cargarEstadisticas() {
        const div = document.getElementById('tablaEstadisticasRender');
        div.innerHTML = '<p style="text-align:center; color:var(--muted); font-size:0.85rem;">Calculando rendimiento...</p>';
        try {
            const req = await fetch('/api/admin/estadisticas', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contrasena: localStorage.getItem(STORAGE_KEY) })
            });
            const res = await req.json();
            
            if (res.status === 'ok') {
                renderTablaEstadisticas(res.abonos, res.ventas);
            } else {
                div.innerHTML = `<p style="text-align:center; color:var(--danger); font-size:0.85rem;">${res.mensaje}</p>`;
            }
        } catch(e) {
            div.innerHTML = '<p style="text-align:center; color:var(--danger); font-size:0.85rem;">Error de conexi√≥n.</p>';
        }
    }

    function renderTablaEstadisticas(abonos, ventas) {
        const stats = {};

        // Funci√≥n para normalizar la fecha a la zona horaria de Colombia (YYYY-MM-DD)
        const getFechaLocal = (isoString) => {
            const date = new Date(isoString);
            const offset = date.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(date.getTime() - offset)).toISOString().split('T')[0];
            return localISOTime;
        };

        // 1. Sumar las boletas NUEVAS registradas (Incluso las de $0)
        ventas.forEach(v => {
            const f = getFechaLocal(v.created_at);
            const asesor = v.asesor || 'Sin Asesor';
            if(!stats[f]) stats[f] = {};
            if(!stats[f][asesor]) stats[f][asesor] = { nuevas: 0, conDinero: 0, recaudado: 0 };
            
            stats[f][asesor].nuevas++;
        });

        // 2. Sumar los ABONOS (Boletas que recibieron dinero y total en $)
        abonos.forEach(a => {
            const f = getFechaLocal(a.fecha_pago);
            const asesor = a.asesor || 'Sin Asesor';
            if(!stats[f]) stats[f] = {};
            if(!stats[f][asesor]) stats[f][asesor] = { nuevas: 0, conDinero: 0, recaudado: 0 };

            stats[f][asesor].conDinero++;
            stats[f][asesor].recaudado += Number(a.monto);
        });

        // 3. Transformar a un arreglo para ordenarlo por fecha (m√°s reciente primero)
        const filas = [];
        Object.keys(stats).forEach(fecha => {
            Object.keys(stats[fecha]).forEach(asesor => {
                filas.push({
                    fecha: fecha,
                    asesor: asesor,
                    ...stats[fecha][asesor]
                });
            });
        });

        filas.sort((a, b) => b.fecha.localeCompare(a.fecha) || b.recaudado - a.recaudado);

        const div = document.getElementById('tablaEstadisticasRender');
        if(filas.length === 0) {
            div.innerHTML = '<p style="text-align:center; color:var(--muted); font-size:0.85rem;">No hay datos para mostrar.</p>';
            return;
        }

        let html = '<div style="overflow-x:auto;"><table style="width:100%; border-collapse:collapse; font-size:0.85rem; text-align:left;">';
        html += '<thead><tr style="border-bottom:2px solid var(--ring-strong); color: var(--ink); font-weight:600;"><th style="padding:10px 4px;">D√≠a</th><th style="padding:10px 4px;">Asesor</th><th style="padding:10px 4px; text-align:center;">Boletas Nuevas</th><th style="padding:10px 4px; text-align:center;">Pagos Recibidos</th><th style="padding:10px 4px; text-align:right;">Total Recaudado</th></tr></thead><tbody>';
        
        filas.forEach(f => {
            const fechaStr = new Date(f.fecha + 'T12:00:00').toLocaleDateString('es-CO', {weekday:'short', day:'2-digit', month:'short'});
            const fmt = new Intl.NumberFormat('es-CO', {style:'currency', currency:'COP', minimumFractionDigits:0}).format(f.recaudado);
            
            html += `<tr style="border-bottom:1px solid var(--ring);">
                        <td style="padding:12px 4px; color:var(--ink-2); text-transform:capitalize;">${fechaStr}</td>
                        <td style="padding:12px 4px; font-weight:600; color:var(--ink);">üë§ ${f.asesor}</td>
                        <td style="padding:12px 4px; text-align:center; font-weight:600; color:var(--muted);">${f.nuevas}</td>
                        <td style="padding:12px 4px; text-align:center; font-weight:600; color:var(--accent-2);">${f.conDinero}</td>
                        <td style="padding:12px 4px; text-align:right; font-weight:800; color:var(--ink);">${fmt}</td>
                    </tr>`;
        });
        
        html += '</tbody></table></div>';
        div.innerHTML = html;
    }

    // ==========================================
    // CARGAR PLATAFORMAS AUTOM√ÅTICAMENTE
    // ==========================================
    async function cargarPlataformas() {
        try {
            const req = await fetch('/api/admin/plataformas');
            const res = await req.json();
            
            if (res.status === 'ok') {
                const datalist = document.getElementById('l_metodos');
                datalist.innerHTML = ''; // Limpiamos la lista vieja
                
                // Agregamos las nuevas opciones sacadas de la base de datos
                res.lista.forEach(plat => {
                    const option = document.createElement('option');
                    option.value = plat;
                    datalist.appendChild(option);
                });
            }
        } catch (e) {
            console.log("No se pudieron cargar las plataformas", e);
        }
    }

    // ==========================================
    // AGREGAR BOLETAS A CLIENTE EXISTENTE
    // ==========================================
    function prepararNuevaVentaExistente(telefono) {
        // 1. Recogemos los datos que ya est√°n en la pantalla del cliente
        const nombre = document.getElementById('c_nombre').value;
        const apellido = document.getElementById('c_apellido').value;
        const ciudad = document.getElementById('c_ciudad').value;

        // 2. Cambiamos a la pesta√±a de "Ventas"
        activateAppMode();
        switchView('view-venta');

        // 3. Llenamos el formulario de venta autom√°ticamente
        document.getElementById('v_nombre').value = nombre;
        document.getElementById('v_apellido').value = apellido;
        document.getElementById('v_telefono').value = telefono;
        document.getElementById('v_ciudad').value = ciudad;

        // 4. Limpiamos las cajas de boletas por si hab√≠a algo escrito antes
        const listaNumeros = document.getElementById('numList');
        listaNumeros.innerHTML = '';
        addDefaultPill(); // Agrega una cajita vac√≠a lista para escribir

        // 5. Subimos la pantalla arriba del todo y por defecto ponemos modo "Solo Separar"
        setMode('separar');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
  </script>
</body>
</html>
